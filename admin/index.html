<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KINN Admin - Event & Teilnehmer Verwaltung</title>

  <!-- Typography: Work Sans -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Work Sans', system-ui, -apple-system, sans-serif;
      background: linear-gradient(180deg, #ffffff 0%, #fafcfb 100%);
      color: #3A3A3A;
      padding: 20px;
      line-height: 1.618;
      min-height: 100vh;
      position: relative;
    }

    /* Subtle neural network background */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background:
        radial-gradient(circle at 20% 30%, rgba(94,217,166,0.08) 0%, transparent 50%),
        radial-gradient(circle at 80% 70%, rgba(94,217,166,0.05) 0%, transparent 50%);
      pointer-events: none;
      z-index: -1;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    /* Logo */
    .logo {
      width: 280px;
      max-width: 70%;
      height: auto;
      margin: 0 auto 2rem;
      display: block;
      filter: drop-shadow(0 4px 16px rgba(0,0,0,0.06));
    }

    .subtitle {
      text-align: center;
      font-size: 0.875rem;
      color: #6B6B6B;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      font-weight: 500;
      margin-bottom: 3rem;
    }

    /* Login Screen */
    #login-screen {
      max-width: 400px;
      margin: 4rem auto;
      text-align: center;
    }

    #login-screen input {
      width: 100%;
      padding: 14px 20px;
      font-size: 1rem;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      margin-bottom: 1rem;
      font-family: inherit;
    }

    #login-screen input:focus {
      outline: none;
      border-color: #5ED9A6;
    }

    .btn {
      display: inline-block;
      padding: 14px 32px;
      background: #5ED9A6;
      color: #000;
      text-decoration: none;
      border: none;
      border-radius: 12px;
      font-size: 1.125rem;
      font-weight: 600;
      letter-spacing: 0.01em;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: inherit;
    }

    .btn:hover {
      background: #4EC995;
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(94, 217, 166, 0.3);
    }

    .btn:active {
      background: #3EB885;
      transform: translateY(0);
    }

    .btn-secondary {
      background: #f5f5f5;
    }

    .btn-secondary:hover {
      background: #e0e0e0;
    }

    .btn-danger {
      background: #ffebee;
      color: #c62828;
    }

    .btn-danger:hover {
      background: #ffcdd2;
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 1rem;
      margin-bottom: 2rem;
      border-bottom: 2px solid #f0f0f0;
    }

    .tab {
      padding: 1rem 2rem;
      background: none;
      border: none;
      border-bottom: 3px solid transparent;
      font-size: 1.125rem;
      font-weight: 500;
      color: #999;
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
    }

    .tab.active {
      color: #000;
      border-bottom-color: #E0EEE9;
    }

    .tab:hover {
      color: #000;
    }

    /* Tab Content */
    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Event List */
    .event-card {
      background: #f9f9f9;
      border-left: 4px solid #E0EEE9;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1rem;
    }

    .event-card h3 {
      font-size: 1.25rem;
      font-weight: 500;
      margin-bottom: 0.5rem;
    }

    .event-meta {
      font-size: 0.9rem;
      color: #666;
      margin-bottom: 0.5rem;
    }

    .event-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
    }

    .btn-small {
      padding: 8px 16px;
      font-size: 0.875rem;
    }

    /* Form */
    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-group label {
      display: block;
      font-weight: 500;
      margin-bottom: 0.5rem;
      color: #333;
    }

    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 12px 16px;
      font-size: 1rem;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-family: inherit;
    }

    .form-group textarea {
      resize: vertical;
      min-height: 100px;
    }

    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #E0EEE9;
    }

    .form-actions {
      display: flex;
      gap: 1rem;
      margin-top: 2rem;
    }

    /* Subscribers List */
    .subscriber-count {
      font-size: 1.25rem;
      font-weight: 500;
      margin-bottom: 1rem;
      color: #333;
    }

    .subscriber-list {
      background: #f9f9f9;
      border-radius: 12px;
      padding: 1.5rem;
      max-height: 500px;
      overflow-y: auto;
    }

    .subscriber-item {
      padding: 0.75rem;
      border-bottom: 1px solid #e0e0e0;
      font-size: 0.95rem;
    }

    .subscriber-item:last-child {
      border-bottom: none;
    }

    /* Messages */
    .message {
      padding: 1rem 1.5rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      font-size: 0.95rem;
    }

    .message.success {
      background: #E0EEE9;
      color: #2e7d32;
    }

    .message.error {
      background: #ffebee;
      color: #c62828;
    }

    /* Hidden */
    .hidden {
      display: none !important;
    }

    /* Loading */
    .loading {
      text-align: center;
      padding: 2rem;
      color: #999;
    }

    /* Dashboard Metrics */
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .metric-card {
      background: #fff;
      border-radius: 12px;
      padding: 1.5rem;
      border-left: 4px solid #5ED9A6;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }

    .metric-card h3 {
      font-size: 0.875rem;
      font-weight: 600;
      color: #6B6B6B;
      margin-bottom: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* General card styling */
    .card {
      background: #fff;
      border-radius: 12px;
      padding: 1.5rem;
      border-left: 4px solid #5ED9A6;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      margin-bottom: 2rem;
    }

    .card h3 {
      font-size: 1rem;
      font-weight: 500;
      color: #333;
      margin-bottom: 1rem;
    }

    .metric-value {
      font-size: 2.5rem;
      font-weight: 300;
      color: #000;
      margin-bottom: 0.5rem;
      line-height: 1;
    }

    .metric-subvalue {
      font-size: 0.95rem;
      color: #666;
      line-height: 1.6;
    }

    .skill-list {
      list-style: none;
      padding: 0;
    }

    .skill-item {
      display: flex;
      justify-content: space-between;
      padding: 0.75rem 0;
      border-bottom: 1px solid #e0e0e0;
    }

    .skill-item:last-child {
      border-bottom: none;
    }

    .skill-name {
      font-weight: 500;
      color: #333;
    }

    .skill-count {
      color: #5ED9A6;
      font-weight: 600;
    }

    @media (max-width: 640px) {
      .logo h1 { font-size: 2rem; }
      .tab { padding: 0.75rem 1rem; font-size: 1rem; }
      .form-actions { flex-direction: column; }
      .btn { width: 100%; }
      .metrics-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- KINN Logo -->
    <svg class="logo" viewBox="0 0 931.35 308.55" xmlns="http://www.w3.org/2000/svg">
      <polygon points="495.04 20.27 569.04 153.27 569.04 20.27 654.04 20.27 654.04 288.27 572.54 288.27 498.04 159.27 498.04 288.27 416.04 288.27 416.04 20.27 495.04 20.27"/>
      <path d="M682.04,20.27l78.89.11,73.11,133.89V20.27h81v268h-80l-72-130v130h-78.5c-.61,0-1.53-.8-2.5,0V20.27Z"/>
      <polygon points="100.04 20.27 100.04 136.27 160.54 20.27 256.04 20.27 182.26 145.61 262.04 288.27 166.54 288.27 100.04 159.27 100.04 288.27 21.04 288.27 21.04 20.27 100.04 20.27"/>
      <path d="M359.04,20.27v265.5c0,.31,1.37,1.42,1,2.5h-82V20.27h81Z"/>
    </svg>
    <p class="subtitle">Admin Dashboard</p>

    <!-- Login Screen -->
    <div id="login-screen">
      <h2 style="margin-bottom: 1.5rem; font-weight: 400;">Admin Login</h2>
      <input type="password" id="password-input" placeholder="Passwort eingeben..." />
      <button class="btn" onclick="login()">Einloggen</button>
      <div id="login-error" class="message error hidden" style="margin-top: 1rem;">
        Falsches Passwort
      </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="admin-dashboard" class="hidden">
      <!-- Tabs -->
      <div class="tabs">
        <button class="tab" onclick="switchTab('dashboard')">Dashboard</button>
        <button class="tab active" onclick="switchTab('events')">Events</button>
        <button class="tab" onclick="switchTab('subscribers')">Teilnehmer</button>
        <button class="tab" onclick="logout()" style="margin-left: auto;">Logout</button>
      </div>

      <!-- Messages -->
      <div id="message-container"></div>

      <!-- Dashboard Tab -->
      <div id="dashboard-tab" class="tab-content">
        <h2 style="font-weight: 400; margin-bottom: 2rem;">Metrics & Insights</h2>
        <div id="dashboard-content" class="loading">Lade Metrics...</div>
      </div>

      <!-- Events Tab -->
      <div id="events-tab" class="tab-content active">
        <div style="display: flex; justify-content: flex-end; align-items: center; margin-bottom: 2rem;">
          <button class="btn" onclick="showEventForm()">+ Neues Event</button>
        </div>

        <!-- Event Form (hidden by default) -->
        <div id="event-form" class="hidden" style="background: #f9f9f9; padding: 2rem; border-radius: 12px; margin-bottom: 2rem;">
          <h3 style="margin-bottom: 1.5rem; font-weight: 400;">Event Details</h3>

          <div class="form-group">
            <label>Event ID (wird automatisch generiert)</label>
            <input type="text" id="event-id" placeholder="kinn-2025-02-15" readonly style="background: #e9ecef; cursor: not-allowed;" />
            <small style="display: block; margin-top: 0.5rem; color: #6B6B6B; font-size: 0.875rem;">
              Format: kinn-YYYY-MM-DD (basierend auf Event-Datum)
            </small>
          </div>

          <div class="form-group">
            <label>Titel *</label>
            <input type="text" id="event-title" placeholder="KINN - KI Treff Innsbruck" />
          </div>

          <div class="form-group">
            <label>Datum *</label>
            <input type="date" id="event-date" onchange="generateEventId()" />
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div class="form-group">
              <label>Start Zeit *</label>
              <input type="time" id="event-start-time" />
            </div>

            <div class="form-group">
              <label>End Zeit *</label>
              <input type="time" id="event-end-time" />
            </div>
          </div>

          <div class="form-group">
            <label>Location *</label>
            <input type="text" id="event-location" placeholder="Coworkingspace Innsbruck" />
          </div>

          <div class="form-group">
            <label>Beschreibung *</label>
            <textarea id="event-description" placeholder="Monatlicher KI-Austausch in Innsbruck..."></textarea>
          </div>

          <div class="form-group">
            <label>URL</label>
            <input type="url" id="event-url" placeholder="https://kinn.at" />
          </div>

          <div class="form-group">
            <label>Status</label>
            <select id="event-status" style="width: 100%; padding: 12px 16px; font-size: 1rem; border: 2px solid #e0e0e0; border-radius: 8px; font-family: inherit;">
              <option value="confirmed">Best√§tigt</option>
              <option value="tentative">Vorl√§ufig</option>
              <option value="cancelled">Abgesagt</option>
            </select>
          </div>

          <div class="form-actions">
            <button class="btn" onclick="saveEvent()">Speichern</button>
            <button class="btn btn-secondary" onclick="cancelEventForm()">Abbrechen</button>
          </div>
        </div>

        <!-- Event List -->
        <div id="events-list" class="loading">Lade Events...</div>
      </div>

      <!-- Subscribers Tab -->
      <div id="subscribers-tab" class="tab-content">
        <h2 style="font-weight: 400; margin-bottom: 2rem;">Teilnehmer Liste</h2>

        <!-- Invite Section -->
        <div class="card" style="border-left: 4px solid #5ED9A6; margin-bottom: 2rem;">
          <h3 style="font-weight: 500; margin-bottom: 0.5rem;">üì® User einladen</h3>
          <p style="color: #666; margin-bottom: 1.5rem; font-size: 0.95rem;">
            Lade jemanden ein, den du bei einem Event getroffen hast.
          </p>

          <div style="margin-bottom: 1rem;">
            <label style="display: block; font-weight: 500; margin-bottom: 0.5rem; font-size: 0.9rem;">Vorname *</label>
            <input type="text" id="inviteName" placeholder="z.B. Sarah" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; font-family: inherit;">
          </div>

          <div style="margin-bottom: 1rem;">
            <label style="display: block; font-weight: 500; margin-bottom: 0.5rem; font-size: 0.9rem;">Email *</label>
            <input type="email" id="inviteEmail" placeholder="email@example.com" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; font-family: inherit;">
          </div>

          <div style="margin-bottom: 1rem;">
            <label style="display: block; font-weight: 500; margin-bottom: 0.5rem; font-size: 0.9rem;">Eingeladen von (optional)</label>
            <input type="text" id="invitedBy" placeholder="Thomas" value="Thomas" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; font-family: inherit;">
          </div>

          <button class="btn" onclick="sendInvite()" style="margin-top: 0.5rem;">
            Einladung senden
          </button>

          <div id="inviteResult" style="margin-top: 1rem;"></div>
        </div>

        <div class="subscriber-count" id="subscriber-count">Lade...</div>

        <div id="subscribers-list" class="loading">Lade Teilnehmer...</div>
      </div>
    </div>
  </div>

  <script>
    // State
    let adminPassword = null;
    let eventsConfig = null;
    let editingEventIndex = null;

    // API base URL
    const API_BASE = '/api/admin';

    // === Authentication ===

    function login() {
      const password = document.getElementById('password-input').value;

      if (!password) {
        showLoginError();
        return;
      }

      // Store password and verify with first API call
      adminPassword = password;
      sessionStorage.setItem('adminPassword', password);

      // Try to load data
      loadEvents().then(success => {
        if (success) {
          document.getElementById('login-screen').classList.add('hidden');
          document.getElementById('admin-dashboard').classList.remove('hidden');
          document.getElementById('login-error').classList.add('hidden');
        } else {
          showLoginError();
          adminPassword = null;
          sessionStorage.removeItem('adminPassword');
        }
      });
    }

    function showLoginError() {
      document.getElementById('login-error').classList.remove('hidden');
      setTimeout(() => {
        document.getElementById('login-error').classList.add('hidden');
      }, 3000);
    }

    function logout() {
      adminPassword = null;
      sessionStorage.removeItem('adminPassword');
      document.getElementById('login-screen').classList.remove('hidden');
      document.getElementById('admin-dashboard').classList.add('hidden');
      document.getElementById('password-input').value = '';
    }

    // Check if already logged in
    window.addEventListener('DOMContentLoaded', () => {
      const savedPassword = sessionStorage.getItem('adminPassword');
      if (savedPassword) {
        adminPassword = savedPassword;
        document.getElementById('password-input').value = savedPassword;
        login();
      }
    });

    // === API Calls ===

    async function apiCall(endpoint, method = 'GET', body = null) {
      const options = {
        method,
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${adminPassword}`
        }
      };

      if (body) {
        options.body = JSON.stringify(body);
      }

      const response = await fetch(API_BASE + endpoint, options);
      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.message || 'API Error');
      }

      return data;
    }

    // === Tab Management ===

    function switchTab(tabName) {
      // Update tab buttons
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
      event.target.classList.add('active');

      // Update tab content
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById(tabName + '-tab').classList.add('active');

      // Load data if needed
      if (tabName === 'subscribers') {
        loadSubscribers();
      } else if (tabName === 'dashboard') {
        loadDashboard();
      }
    }

    // === Messages ===

    function showMessage(message, type = 'success') {
      const container = document.getElementById('message-container');
      const div = document.createElement('div');
      div.className = `message ${type}`;
      div.textContent = message;
      container.innerHTML = '';
      container.appendChild(div);

      setTimeout(() => {
        div.remove();
      }, 5000);
    }

    // === Events Management ===

    async function loadEvents() {
      try {
        const response = await apiCall('/events');
        eventsConfig = response.data;
        renderEvents();
        return true;
      } catch (error) {
        console.error('Failed to load events:', error);
        document.getElementById('events-list').innerHTML =
          `<div class="message error">Fehler beim Laden: ${error.message}</div>`;
        return false;
      }
    }

    function renderEvents() {
      const container = document.getElementById('events-list');
      const events = eventsConfig.events || [];

      if (events.length === 0) {
        container.innerHTML = '<p style="color: #999; text-align: center; padding: 2rem;">Noch keine Events vorhanden.</p>';
        return;
      }

      container.innerHTML = events.map((event, index) => `
        <div class="event-card">
          <h3>${event.title}</h3>
          <div class="event-meta">
            ${formatDate(event.date)} ‚Ä¢ ${event.startTime} - ${event.endTime}
          </div>
          <div class="event-meta">${event.location}</div>
          <div class="event-meta">${event.description}</div>
          ${event.url ? `<div class="event-meta"><a href="${event.url}" target="_blank" style="color: #5ED9A6;">${event.url}</a></div>` : ''}
          <div class="event-meta">Status: ${getStatusLabel(event.status)}</div>
          <div class="event-actions">
            <button class="btn btn-small btn-secondary" onclick="editEvent(${index})">Bearbeiten</button>
            <button class="btn btn-small btn-danger" onclick="deleteEvent(${index})">L√∂schen</button>
          </div>
        </div>
      `).join('');
    }

    function formatDate(dateStr) {
      const date = new Date(dateStr);
      return date.toLocaleDateString('de-DE', {
        weekday: 'short',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
    }

    function getStatusLabel(status) {
      const labels = {
        confirmed: 'Best√§tigt',
        tentative: 'Vorl√§ufig',
        cancelled: 'Abgesagt'
      };
      return labels[status] || status;
    }

    function showEventForm(event = null) {
      document.getElementById('event-form').classList.remove('hidden');

      if (event) {
        // Edit mode
        document.getElementById('event-id').value = event.id;
        document.getElementById('event-title').value = event.title;
        document.getElementById('event-date').value = event.date;
        document.getElementById('event-start-time').value = event.startTime;
        document.getElementById('event-end-time').value = event.endTime;
        document.getElementById('event-location').value = event.location;
        document.getElementById('event-description').value = event.description;
        document.getElementById('event-url').value = event.url || '';
        document.getElementById('event-status').value = event.status || 'confirmed';
      } else {
        // Add mode
        clearEventForm();
      }

      // Scroll to form
      document.getElementById('event-form').scrollIntoView({ behavior: 'smooth' });
    }

    function generateEventId() {
      const dateInput = document.getElementById('event-date').value;
      if (!dateInput) {
        document.getElementById('event-id').value = '';
        return;
      }

      // Format: kinn-YYYY-MM-DD
      const eventId = `kinn-${dateInput}`;
      document.getElementById('event-id').value = eventId;
    }

    function clearEventForm() {
      document.getElementById('event-id').value = '';
      document.getElementById('event-title').value = '';
      document.getElementById('event-date').value = '';
      document.getElementById('event-start-time').value = '';
      document.getElementById('event-end-time').value = '';
      document.getElementById('event-location').value = '';
      document.getElementById('event-description').value = '';
      document.getElementById('event-url').value = 'https://kinn.at';
      document.getElementById('event-status').value = 'confirmed';

      // Set default date to today and generate ID
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('event-date').value = today;
      generateEventId();
    }

    function cancelEventForm() {
      document.getElementById('event-form').classList.add('hidden');
      editingEventIndex = null;
    }

    function editEvent(index) {
      editingEventIndex = index;
      showEventForm(eventsConfig.events[index]);
    }

    async function deleteEvent(index) {
      if (!confirm('Event wirklich l√∂schen?')) return;

      const events = [...eventsConfig.events];
      events.splice(index, 1);

      try {
        await apiCall('/events', 'PUT', {
          events,
          defaults: eventsConfig.defaults
        });

        showMessage('Event gel√∂scht!');
        await loadEvents();
      } catch (error) {
        showMessage('Fehler beim L√∂schen: ' + error.message, 'error');
      }
    }

    async function saveEvent() {
      // Get form values
      const event = {
        id: document.getElementById('event-id').value.trim(),
        title: document.getElementById('event-title').value.trim(),
        date: document.getElementById('event-date').value,
        startTime: document.getElementById('event-start-time').value,
        endTime: document.getElementById('event-end-time').value,
        location: document.getElementById('event-location').value.trim(),
        description: document.getElementById('event-description').value.trim(),
        url: document.getElementById('event-url').value.trim() || 'https://kinn.at',
        status: document.getElementById('event-status').value
      };

      // Validate
      const required = ['id', 'title', 'date', 'startTime', 'endTime', 'location', 'description'];
      for (const field of required) {
        if (!event[field]) {
          showMessage(`Bitte ${field} ausf√ºllen!`, 'error');
          return;
        }
      }

      // Update or add
      const events = [...eventsConfig.events];
      if (editingEventIndex !== null) {
        events[editingEventIndex] = event;
      } else {
        events.push(event);
      }

      // Sort by date
      events.sort((a, b) => new Date(a.date) - new Date(b.date));

      try {
        await apiCall('/events', 'PUT', {
          events,
          defaults: eventsConfig.defaults
        });

        showMessage(editingEventIndex !== null ? 'Event aktualisiert!' : 'Event erstellt!');
        cancelEventForm();
        await loadEvents();
        editingEventIndex = null;
      } catch (error) {
        showMessage('Fehler beim Speichern: ' + error.message, 'error');
      }
    }

    // === Subscribers Management ===

    async function loadSubscribers() {
      const container = document.getElementById('subscribers-list');
      const countElement = document.getElementById('subscriber-count');

      try {
        const response = await apiCall('/subscribers');
        const { subscribers, count } = response.data;

        countElement.textContent = `${count} Teilnehmer`;

        if (subscribers.length === 0) {
          container.innerHTML = '<p style="color: #999; text-align: center; padding: 2rem;">Noch keine Teilnehmer.</p>';
          return;
        }

        container.innerHTML = `
          <div class="subscriber-list">
            ${subscribers.map(email => `<div class="subscriber-item">${email}</div>`).join('')}
          </div>
        `;
      } catch (error) {
        console.error('Failed to load subscribers:', error);
        container.innerHTML = `<div class="message error">Fehler beim Laden: ${error.message}</div>`;
      }
    }

    // Send Invite
    async function sendInvite() {
      const nameInput = document.getElementById('inviteName');
      const emailInput = document.getElementById('inviteEmail');
      const invitedByInput = document.getElementById('invitedBy');
      const resultDiv = document.getElementById('inviteResult');

      const name = nameInput.value.trim();
      const email = emailInput.value.trim();
      const invitedBy = invitedByInput.value.trim() || 'Thomas';

      if (!name || !email) {
        resultDiv.innerHTML = '<div class="message error">‚ùå Bitte Name und Email eingeben</div>';
        return;
      }

      // Show loading state
      resultDiv.innerHTML = '<div class="message">‚è≥ Einladung wird versendet...</div>';

      try {
        const response = await fetch('/api/admin/invite', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${adminPassword}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ name, email, invitedBy })
        });

        const data = await response.json();

        if (response.ok) {
          resultDiv.innerHTML = `<div class="message success">‚úÖ ${data.message}</div>`;
          // Clear form
          nameInput.value = '';
          emailInput.value = '';
          invitedByInput.value = 'Thomas';

          // Refresh subscriber list after a short delay
          setTimeout(() => {
            loadSubscribers();
          }, 1000);
        } else {
          resultDiv.innerHTML = `<div class="message error">‚ùå ${data.message || data.error}</div>`;
        }
      } catch (error) {
        console.error('[INVITE] Error:', error);
        resultDiv.innerHTML = `<div class="message error">‚ùå Fehler: ${error.message}</div>`;
      }
    }

    // === Dashboard Metrics ===

    async function loadDashboard() {
      const container = document.getElementById('dashboard-content');
      container.innerHTML = '<div class="loading">Lade Dashboard Metrics...</div>';

      try {
        const response = await apiCall('/dashboard');
        renderDashboard(response.metrics);
      } catch (error) {
        console.error('[DASHBOARD] Error:', error);
        container.innerHTML = `<div class="message error">Fehler beim Laden: ${error.message}</div>`;
      }
    }

    function renderDashboard(metrics) {
      const container = document.getElementById('dashboard-content');

      const html = `
        <!-- Subscriber Metrics -->
        <div class="metrics-grid">
          <div class="metric-card">
            <h3>Total Subscribers</h3>
            <div class="metric-value">${metrics.subscribers.total}</div>
            <div class="metric-subvalue">
              ‚úÖ ${metrics.subscribers.complete} complete (${metrics.subscribers.completionRate}%)<br>
              ‚ö†Ô∏è ${metrics.subscribers.incomplete} incomplete
            </div>
          </div>

          <div class="metric-card">
            <h3>Upcoming Events</h3>
            <div class="metric-value">${metrics.events.upcoming}</div>
            <div class="metric-subvalue">
              ${metrics.events.nextEvent ? `Next: ${metrics.events.nextEvent.title}` : 'No events scheduled'}
            </div>
          </div>

          <div class="metric-card">
            <h3>Last Event RSVP</h3>
            <div class="metric-value">${metrics.events.lastEvent ? metrics.events.lastEvent.rsvps.total : '‚Äî'}</div>
            <div class="metric-subvalue">
              ${metrics.events.lastEvent
                ? `${metrics.events.lastEvent.rsvps.yes} Yes ¬∑ ${metrics.events.lastEvent.rsvps.maybe} Maybe`
                : 'No past events'}
            </div>
          </div>
        </div>

        <!-- Top Skills -->
        <div class="card">
          <h3 style="margin-bottom: 1rem; font-weight: 500;">üî• Top Skills (${metrics.skills.total} total)</h3>
          <ul class="skill-list">
            ${metrics.skills.top.slice(0, 10).map(skill => `
              <li class="skill-item">
                <span class="skill-name">${skill.skill}</span>
                <span class="skill-count">${skill.count}</span>
              </li>
            `).join('')}
          </ul>
        </div>

        <!-- Distribution Stats -->
        <div class="metrics-grid">
          <div class="metric-card">
            <h3>Location Split</h3>
            <div class="metric-subvalue">
              üìç Tirol: ${metrics.location.tirol} (${Math.round(metrics.location.tirol / metrics.subscribers.total * 100)}%)<br>
              üåê Online: ${metrics.location.online} (${Math.round(metrics.location.online / metrics.subscribers.total * 100)}%)<br>
              üîÄ All: ${metrics.location.all} (${Math.round(metrics.location.all / metrics.subscribers.total * 100)}%)
            </div>
          </div>

          <div class="metric-card">
            <h3>Work Status</h3>
            <div class="metric-subvalue">
              üíº Employed: ${metrics.work.employed}<br>
              üöÄ Freelancer: ${metrics.work.freelancer}<br>
              üéì Student: ${metrics.work.student}<br>
              üîç Between Jobs: ${metrics.work.betweenJobs}
            </div>
          </div>

          <div class="metric-card">
            <h3>Experience Level</h3>
            <div class="metric-subvalue">
              üå± Junior: ${metrics.level.junior}<br>
              üìà Mid: ${metrics.level.mid}<br>
              üéØ Senior: ${metrics.level.senior}<br>
              ‚≠ê Lead: ${metrics.level.lead}
            </div>
          </div>
        </div>

        ${metrics.subscribers.incomplete > 0 ? `
          <div class="card" style="border-left: 4px solid #ff6b6b;">
            <h3 style="color: #ff6b6b; margin-bottom: 1rem;">‚ö†Ô∏è ${metrics.subscribers.incomplete} Incomplete Profiles</h3>
            <p style="color: #666; margin-bottom: 1rem; font-size: 0.95rem;">
              These users signed up but haven't completed their profile yet.
            </p>
          </div>
        ` : ''}
      `;

      container.innerHTML = html;
    }
  </script>
</body>
</html>
