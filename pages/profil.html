<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mein KINN Portal</title>
  <meta name="description" content="Dein pers√∂nliches KINN Portal - Dashboard, Profil & Einstellungen f√ºr den KI Treff Innsbruck.">

  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="/public/favicon.svg">
  <link rel="apple-touch-icon" sizes="180x180" href="/public/apple-touch-icon.png">

  <!-- Typography: Work Sans -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@300;400;500;600;700;900&display=swap" rel="stylesheet">

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    /* Subtle mint gradient background */
    body {
      font-family: 'Work Sans', system-ui, -apple-system, sans-serif;
      background: linear-gradient(180deg, #ffffff 0%, #fafcfb 100%);
      color: #3A3A3A;
      line-height: 1.618;
      font-weight: 400;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      position: relative;
    }

    /* Subtle neural network background */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background:
        radial-gradient(circle at 20% 30%, rgba(94,217,166,0.08) 0%, transparent 50%),
        radial-gradient(circle at 80% 70%, rgba(94,217,166,0.05) 0%, transparent 50%);
      pointer-events: none;
      z-index: -1;
    }

    .container {
      max-width: 640px;
      width: 100%;
      text-align: center;
    }

    /* Logo */
    .logo {
      width: 280px;
      max-width: 70%;
      height: auto;
      margin: 0 auto 3rem;
      display: block;
      filter: drop-shadow(0 4px 16px rgba(0,0,0,0.06));
    }

    /* Profile Avatar (Gravatar + Initials Fallback) */
    .profile-avatar {
      width: 80px;
      height: 80px;
      margin: 0 auto 1.5rem;
      border-radius: 50%;
      display: block;
      box-shadow: 0 8px 24px rgba(94, 217, 166, 0.25);
      animation: fadeInScale 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
      object-fit: cover;
      border: 3px solid rgba(94, 217, 166, 0.2);
      transition: all 0.3s ease;
    }

    .profile-avatar:hover {
      transform: scale(1.05);
      box-shadow: 0 12px 32px rgba(94, 217, 166, 0.35);
    }

    /* Status indicator (legacy - kept for error states) */
    .status-indicator {
      width: 64px;
      height: 64px;
      margin: 0 auto 1.5rem;
      border-radius: 50%;
      background: linear-gradient(135deg, #5ED9A6 0%, #4EC995 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 8px 24px rgba(94, 217, 166, 0.25);
      animation: fadeInScale 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .status-indicator svg {
      width: 32px;
      height: 32px;
      stroke: white;
      stroke-width: 3;
      stroke-linecap: round;
      stroke-linejoin: round;
      fill: none;
    }

    @keyframes fadeInScale {
      from {
        opacity: 0;
        transform: scale(0.8);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    /* Typography */
    h1 {
      font-family: 'Work Sans', sans-serif;
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 0.75rem;
      color: #2C3E50;
      letter-spacing: 0.02em;
      line-height: 1.3;
    }

    .subtitle {
      font-family: 'Work Sans', sans-serif;
      font-size: 1rem;
      color: #6B6B6B;
      margin-bottom: 3rem;
      font-weight: 400;
      letter-spacing: 0.02em;
      line-height: 1.5;
    }

    /* Card */
    .card {
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(10px);
      border-radius: 1rem;
      padding: 2rem;
      margin-bottom: 1.5rem;
      border: 1px solid rgba(0, 0, 0, 0.06);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.04);
      text-align: left;
    }

    .card h2 {
      font-family: 'Work Sans', sans-serif;
      font-size: 1.125rem;
      font-weight: 600;
      color: #2C3E50;
      margin-bottom: 0.75rem;
      letter-spacing: 0.01em;
    }

    .card p {
      font-size: 0.9375rem;
      color: #6B6B6B;
      margin-bottom: 0.5rem;
      line-height: 1.6;
    }

    /* Welcome Card with Dismiss */
    .welcome-card {
      position: relative;
    }

    .dismiss-btn {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: transparent;
      border: none;
      font-size: 1.5rem;
      color: #999;
      cursor: pointer;
      padding: 0.25rem 0.5rem;
      line-height: 1;
      transition: all 0.2s ease;
      border-radius: 4px;
    }

    .dismiss-btn:hover {
      color: #333;
      background: rgba(0, 0, 0, 0.05);
    }

    .dismiss-btn:active {
      transform: scale(0.95);
    }

    .meta {
      font-size: 0.875rem;
      color: #999;
      margin-top: 0.75rem;
    }

    /* Toggle Switch */
    .preference-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem;
      background: rgba(255, 255, 255, 0.6);
      border-radius: 0.75rem;
      margin-top: 1rem;
    }

    .preference-label {
      font-size: 0.9375rem;
      font-weight: 500;
      color: #3A3A3A;
    }

    .preference-description {
      font-size: 0.8125rem;
      color: #6B6B6B;
      margin-top: 0.25rem;
    }

    .toggle-switch {
      position: relative;
      width: 52px;
      height: 28px;
      flex-shrink: 0;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      border-radius: 28px;
      transition: 0.3s;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      border-radius: 50%;
      transition: 0.3s;
    }

    input:checked + .toggle-slider {
      background-color: #5ED9A6;
    }

    input:checked + .toggle-slider:before {
      transform: translateX(24px);
    }

    /* Buttons */
    .cta-button {
      font-family: 'Work Sans', sans-serif;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 1rem 2rem;
      background: #5ED9A6;
      color: #000;
      text-decoration: none;
      border-radius: 0.75rem;
      font-size: 1rem;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
      letter-spacing: 0.01em;
      /* Mobile-First: Full-width f√ºr optimale Thumb-Erreichbarkeit */
      width: 100%;
      max-width: none;
      margin: 0 auto 1rem;
    }

    /* Desktop: Right-align f√ºr visuelle Balance */
    @media (min-width: 768px) {
      .cta-button {
        width: auto;
        min-width: 240px;
        max-width: 360px;
        margin: 0 0 1rem auto;
      }
    }

    .cta-button:hover:not(:disabled) {
      background: #4EC995;
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(94, 217, 166, 0.3);
    }

    .cta-button:active:not(:disabled) {
      background: #3EB885;
      transform: translateY(0);
    }

    .cta-button:disabled {
      background: #ccc;
      cursor: not-allowed;
      opacity: 0.6;
    }

    /* Danger button */
    .danger-button {
      background: rgba(239, 68, 68, 0.1);
      color: #dc2626;
      border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .danger-button:hover:not(:disabled) {
      background: rgba(239, 68, 68, 0.2);
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.2);
    }

    .danger-button:active:not(:disabled) {
      background: rgba(239, 68, 68, 0.3);
    }

    /* Secondary button */
    .secondary-button {
      background: rgba(255, 255, 255, 0.8);
      color: #6B6B6B;
      border: 1px solid rgba(0, 0, 0, 0.12);
    }

    /* Jony Ive approved: Ultra-subtle troubleshooting */
    .troubleshoot-hint:hover {
      opacity: 0.7 !important;
    }

    .gentle-refresh {
      background: none;
      border: none;
      color: #999;
      font-size: 0.8125rem;
      font-weight: 400;
      cursor: pointer;
      text-decoration: underline;
      text-underline-offset: 3px;
      text-decoration-color: rgba(153, 153, 153, 0.3);
      padding: 4px 8px;
      transition: all 0.3s cubic-bezier(0.25, 0.1, 0.25, 1);
      font-family: 'Work Sans', system-ui, -apple-system, sans-serif;
    }

    .gentle-refresh:hover {
      color: #6B6B6B;
      text-decoration-color: rgba(94, 217, 166, 0.4);
    }

    .gentle-refresh:active {
      transform: scale(0.98);
    }

    .secondary-button:hover:not(:disabled) {
      background: rgba(255, 255, 255, 0.95);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      color: #3A3A3A;
    }

    .secondary-button:active:not(:disabled) {
      background: rgba(255, 255, 255, 1);
    }

    /* Loading state */
    .loading {
      text-align: center;
      padding: 2rem;
      color: #6B6B6B;
    }

    .spinner {
      width: 48px;
      height: 48px;
      margin: 0 auto 1rem;
      border: 4px solid rgba(94, 217, 166, 0.2);
      border-top-color: #5ED9A6;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Error state */
    .error-message {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: #dc2626;
      padding: 1rem;
      border-radius: 0.75rem;
      margin-bottom: 1.5rem;
      font-size: 0.9375rem;
    }

    /* Success message */
    .success-message {
      background: rgba(94, 217, 166, 0.1);
      border: 1px solid rgba(94, 217, 166, 0.3);
      color: #059669;
      padding: 1rem;
      border-radius: 0.75rem;
      margin-bottom: 1.5rem;
      font-size: 0.9375rem;
    }

    /* Tab Navigation */
    .tab-navigation {
      display: flex;
      margin-bottom: 2rem;
      border-bottom: 2px solid rgba(0, 0, 0, 0.06);
      position: relative;
    }

    .tab-button {
      font-family: 'Work Sans', sans-serif;
      flex: 1;
      padding: 1rem 1.5rem;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 0.9375rem;
      font-weight: 500;
      color: #6B6B6B;
      position: relative;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border-bottom: 3px solid transparent;
      margin-bottom: -2px;
      text-align: center;
      white-space: nowrap;
    }

    .tab-button:hover {
      color: #3A3A3A;
      background: rgba(94, 217, 166, 0.05);
    }

    .tab-button.active {
      color: #2C3E50;
      font-weight: 600;
      border-bottom-color: #5ED9A6;
      background: rgba(94, 217, 166, 0.08);
    }

    .tab-button.active:hover {
      background: rgba(94, 217, 166, 0.12);
    }

    /* Subtle dividers between tabs */
    .tab-button:not(:last-child)::after {
      content: '';
      position: absolute;
      right: 0;
      top: 25%;
      bottom: 25%;
      width: 1px;
      background: rgba(0, 0, 0, 0.06);
      transition: opacity 0.2s ease;
    }

    .tab-button:hover::after,
    .tab-button.active::after,
    .tab-button.active + .tab-button::after {
      opacity: 0;
    }

    /* Settings icon styles */
    .settings-icon {
      display: none;
      vertical-align: middle;
    }

    .settings-text {
      vertical-align: middle;
    }

    /* Mobile: Show icon, hide text for settings */
    @media (max-width: 640px) {
      .tab-button {
        padding: 0.875rem 0.5rem;
        font-size: 0.875rem;
        flex: 1;
      }

      /* Remove dividers on mobile for cleaner look */
      .tab-button::after {
        display: none;
      }

      .settings-icon {
        display: inline-block;
      }

      .settings-text {
        display: none;
      }
    }

    /* Desktop: Show both icon and text */
    @media (min-width: 641px) {
      .settings-icon {
        display: inline-block;
        margin-right: 0.5rem;
      }
    }

    /* Form Elements */
    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-label {
      display: block;
      font-size: 0.875rem;
      font-weight: 600;
      color: #2C3E50;
      margin-bottom: 0.5rem;
      letter-spacing: 0.01em;
    }

    .form-input {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid rgba(0, 0, 0, 0.12);
      border-radius: 0.5rem;
      font-family: 'Work Sans', sans-serif;
      font-size: 0.9375rem;
      transition: all 0.2s ease;
      background: rgba(255, 255, 255, 0.8);
    }

    .form-input:focus {
      outline: none;
      border-color: #5ED9A6;
      box-shadow: 0 0 0 3px rgba(94, 217, 166, 0.1);
    }

    .form-select {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid rgba(0, 0, 0, 0.12);
      border-radius: 0.5rem;
      font-family: 'Work Sans', sans-serif;
      font-size: 0.9375rem;
      background: rgba(255, 255, 255, 0.8);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .form-select:focus {
      outline: none;
      border-color: #5ED9A6;
      box-shadow: 0 0 0 3px rgba(94, 217, 166, 0.1);
    }

    .form-textarea {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid rgba(0, 0, 0, 0.12);
      border-radius: 0.5rem;
      font-family: 'Work Sans', sans-serif;
      font-size: 0.9375rem;
      min-height: 100px;
      resize: vertical;
      background: rgba(255, 255, 255, 0.8);
      transition: all 0.2s ease;
    }

    .form-textarea:focus {
      outline: none;
      border-color: #5ED9A6;
      box-shadow: 0 0 0 3px rgba(94, 217, 166, 0.1);
    }

    /* Multi-Select Chips */
    .chip-container {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0.75rem;
      background: rgba(94, 217, 166, 0.15);
      border: 1px solid rgba(94, 217, 166, 0.3);
      border-radius: 2rem;
      font-size: 0.8125rem;
      font-weight: 500;
      color: #2C3E50;
      cursor: pointer;
      transition: all 0.2s ease;
      user-select: none;
    }

    .chip:hover {
      background: rgba(94, 217, 166, 0.25);
    }

    .chip.selected {
      background: #5ED9A6;
      border-color: #4EC995;
      color: #000;
      font-weight: 600;
      box-shadow: 0 2px 8px rgba(94, 217, 166, 0.3);
      transform: scale(1.02);
    }

    .chip.selected::before {
      content: '‚úì ';
      font-weight: 700;
    }

    /* Selected Skills Bar */
    #selectedSkillsBar {
      background: rgba(94, 217, 166, 0.08);
      border: 1px solid rgba(94, 217, 166, 0.3);
      border-radius: 8px;
      padding: 0.625rem;
      margin-bottom: 1rem;
      max-height: 200px; /* H√∂her f√ºr 20 Skills (~6-7 Zeilen) */
      display: flex;
      align-items: flex-start; /* Top-align f√ºr multi-line */
      gap: 0.25rem; /* Noch kompaktere gaps */
      flex-wrap: wrap;
      overflow-y: auto; /* Vertical scroll bei vielen Skills */
      -webkit-overflow-scrolling: touch; /* iOS momentum scroll */
      position: relative;
      transition: all 0.3s ease; /* Smooth resize */
    }

    /* Smooth scroll styling */
    #selectedSkillsBar {
      scrollbar-width: thin;
      scrollbar-color: rgba(94, 217, 166, 0.4) transparent;
    }

    #selectedSkillsBar::-webkit-scrollbar {
      width: 6px;
    }

    #selectedSkillsBar::-webkit-scrollbar-track {
      background: transparent;
    }

    #selectedSkillsBar::-webkit-scrollbar-thumb {
      background: rgba(94, 217, 166, 0.4);
      border-radius: 3px;
    }

    #selectedSkillsBar::-webkit-scrollbar-thumb:hover {
      background: rgba(94, 217, 166, 0.6);
    }

    /* Fade gradient at bottom when scrollable (Apple-style indicator) */
    #selectedSkillsBar.has-overflow::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 24px;
      background: linear-gradient(to bottom, transparent, rgba(94, 217, 166, 0.12));
      pointer-events: none;
      border-radius: 0 0 8px 8px;
      opacity: 1;
    }

    #selectedSkillsBar.empty {
      opacity: 0.5;
      font-size: 0.875rem;
      color: #999;
      justify-content: center;
      align-items: center;
      min-height: 48px; /* Minimal height when empty */
      overflow: hidden;
    }

    #selectedSkillsBar .chip {
      background: #5ED9A6;
      color: #000;
      font-weight: 600;
      padding: 0.25rem 0.375rem; /* Viel kompakter */
      font-size: 0.75rem; /* 12px - noch kleiner */
      display: flex;
      align-items: center;
      gap: 0.25rem; /* Minimal gap zum √ó */
      flex-shrink: 0; /* Prevent chips from shrinking */
      border-radius: 5px; /* Kompakter */
      line-height: 1.2;
    }

    #selectedSkillsBar .chip-remove {
      background: rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      width: 14px; /* Noch kleiner */
      height: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.6875rem; /* 11px - kleinere √ó */
      line-height: 1;
      transition: all 0.2s ease;
      cursor: pointer;
      border: none;
      padding: 0;
      color: #000;
    }

    #selectedSkillsBar .chip-remove:hover {
      background: rgba(0, 0, 0, 0.2);
      transform: scale(1.15);
    }

    /* Prominent Skill Counter */
    #skillCounter {
      font-size: 1rem;
      font-weight: 600;
      padding: 0.25rem 0.75rem;
      border-radius: 4px;
      transition: all 0.3s ease;
    }

    #skillCounter.low {
      background: rgba(94, 217, 166, 0.1);
      color: #2C3E50;
    }

    #skillCounter.medium {
      background: rgba(251, 191, 36, 0.15);
      color: #d97706;
    }

    #skillCounter.high {
      background: rgba(239, 68, 68, 0.15);
      color: #dc2626;
    }

    /* Sticky Search Box */
    .skills-search-container {
      position: sticky;
      top: 0;
      background: linear-gradient(180deg, #ffffff 0%, #fafcfb 100%);
      padding: 0.5rem 0 1rem 0;
      margin: 0 -0.5rem;
      padding-left: 0.5rem;
      padding-right: 0.5rem;
      z-index: 10;
      border-bottom: 1px solid transparent;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }

    .skills-search-container.scrolled {
      border-bottom-color: rgba(0, 0, 0, 0.08);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }

    .chip-remove {
      background: none;
      border: none;
      padding: 0;
      width: 16px;
      height: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: currentColor;
      font-size: 1.125rem;
      line-height: 1;
    }

    /* Domain Filters (Apple-inspired) */
    .domain-filters {
      display: flex;
      gap: 0.5rem;
      overflow-x: auto;
      overflow-y: hidden;
      padding: 1rem 0;
      margin-bottom: 1.5rem;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: thin;
      scrollbar-color: rgba(0, 0, 0, 0.2) transparent;
    }

    .domain-filters::-webkit-scrollbar {
      height: 6px;
    }

    .domain-filters::-webkit-scrollbar-thumb {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 3px;
    }

    .domain-chip {
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
      padding: 0.625rem 1rem;
      background: rgba(255, 255, 255, 0.8);
      border: 1.5px solid rgba(0, 0, 0, 0.12);
      border-radius: 20px;
      font-size: 0.875rem;
      font-weight: 500;
      color: #2C3E50;
      cursor: pointer;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      white-space: nowrap;
      flex-shrink: 0;
    }

    .domain-chip:hover {
      background: rgba(255, 255, 255, 1);
      border-color: var(--domain-color, rgba(94, 217, 166, 0.4));
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .domain-chip.active {
      background: var(--domain-color, #5ED9A6);
      border-color: var(--domain-color, #4EC995);
      color: #fff;
      font-weight: 600;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.15);
      transform: scale(1.02);
    }

    .domain-chip .count {
      opacity: 0.7;
      font-size: 0.8125rem;
    }

    .domain-chip.active .count {
      opacity: 0.9;
    }

    /* Flat Skills Grid (content-aware width - Apple-style) */
    .skills-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 0.625rem;
      margin-top: 1rem;
      animation: fadeInGrid 0.4s ease-out;
      max-height: 600px; /* ~12-15 Zeilen sichtbar */
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch; /* iOS smooth scroll */
      position: relative;
      padding-bottom: 24px; /* Space for fade gradient */
    }

    /* Smooth scrollbar for skills grid */
    .skills-grid {
      scrollbar-width: thin;
      scrollbar-color: rgba(94, 217, 166, 0.3) transparent;
    }

    .skills-grid::-webkit-scrollbar {
      width: 8px;
    }

    .skills-grid::-webkit-scrollbar-track {
      background: transparent;
    }

    .skills-grid::-webkit-scrollbar-thumb {
      background: rgba(94, 217, 166, 0.3);
      border-radius: 4px;
    }

    .skills-grid::-webkit-scrollbar-thumb:hover {
      background: rgba(94, 217, 166, 0.5);
    }

    /* Fade gradient at bottom (Apple-style "there's more" indicator) */
    .skills-grid::after {
      content: '';
      position: sticky;
      bottom: 0;
      left: 0;
      right: 0;
      height: 32px;
      background: linear-gradient(to bottom, transparent, rgba(255, 255, 255, 0.95));
      pointer-events: none;
      z-index: 1;
    }

    @keyframes fadeInGrid {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @media (max-width: 768px) {
      .skills-grid {
        gap: 0.5rem;
        max-height: 500px; /* Etwas kleiner auf Mobile */
      }
    }

    /* Color dot indicator for skills */
    .skills-grid .chip {
      position: relative;
      padding-left: 1.5rem;
      justify-content: flex-start;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .skills-grid .chip::before {
      content: '';
      position: absolute;
      left: 0.625rem;
      top: 50%;
      transform: translateY(-50%);
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--domain-color, #6B7280);
      opacity: 0.6;
      transition: all 0.2s ease;
    }

    .skills-grid .chip.selected::before {
      opacity: 1;
      width: 7px;
      height: 7px;
      box-shadow: 0 0 8px var(--domain-color);
    }

    .skills-grid .chip:hover::before {
      opacity: 0.9;
      transform: translateY(-50%) scale(1.2);
    }

    /* Hide skill chips when filtered out */
    .skills-grid .chip.hidden {
      display: none;
    }

    /* Radio Group */
    .radio-group {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      margin-top: 0.5rem;
    }

    .radio-option {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      background: rgba(255, 255, 255, 0.6);
      border: 1px solid rgba(0, 0, 0, 0.08);
      border-radius: 0.5rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .radio-option:hover {
      background: rgba(255, 255, 255, 0.9);
      border-color: rgba(94, 217, 166, 0.3);
    }

    .radio-option input[type="radio"] {
      width: 18px;
      height: 18px;
      margin: 0;
      cursor: pointer;
      accent-color: #5ED9A6;
    }

    .radio-option label {
      flex: 1;
      cursor: pointer;
      font-size: 0.9375rem;
      color: #3A3A3A;
    }

    /* Checkbox Group */
    .checkbox-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .checkbox-option {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      background: rgba(255, 255, 255, 0.6);
      border: 1px solid rgba(0, 0, 0, 0.08);
      border-radius: 0.5rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .checkbox-option:hover {
      background: rgba(255, 255, 255, 0.9);
      border-color: rgba(94, 217, 166, 0.3);
    }

    .checkbox-option input[type="checkbox"] {
      width: 18px;
      height: 18px;
      margin: 0;
      cursor: pointer;
      accent-color: #5ED9A6;
    }

    .checkbox-option label {
      flex: 1;
      cursor: pointer;
      font-size: 0.9375rem;
      color: #3A3A3A;
    }

    /* Section Divider */
    .section-divider {
      margin: 2rem 0;
      border: none;
      border-top: 1px solid rgba(0, 0, 0, 0.08);
    }

    /* Match Hints */
    .match-hints {
      background: rgba(94, 217, 166, 0.1);
      border: 1px solid rgba(94, 217, 166, 0.3);
      border-radius: 0.75rem;
      padding: 1rem 1.25rem;
      margin-top: 1rem;
    }

    .match-hints h3 {
      font-size: 0.875rem;
      font-weight: 600;
      color: #2C3E50;
      margin-bottom: 0.5rem;
    }

    .match-hints ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .match-hints li {
      font-size: 0.875rem;
      color: #3A3A3A;
      padding: 0.25rem 0;
      padding-left: 1.25rem;
      position: relative;
    }

    .match-hints li::before {
      content: '‚Üí';
      position: absolute;
      left: 0;
      color: #5ED9A6;
      font-weight: 600;
    }

    /* Footer */
    .footer {
      margin-top: 4rem;
      font-size: 0.75rem;
      color: #ccc;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      font-weight: 500;
    }

    /* Responsive */
    @media (max-width: 640px) {
      body {
        padding: 1.5rem;
      }

      .logo {
        width: 200px;
        margin-bottom: 2rem;
      }

      h1 {
        font-size: 1.5rem;
      }

      .subtitle {
        font-size: 0.9375rem;
        margin-bottom: 2rem;
      }

      .card {
        padding: 1.5rem;
      }

      .cta-button {
        padding: 0.875rem 1.5rem;
        font-size: 0.9375rem;
      }
    }
    /* Dashboard: Event List */
    .event-list {
      list-style: none;
      padding: 0;
    }

    .event-item {
      padding: 1rem;
      background: rgba(94,217,166,0.05);
      border-radius: 8px;
      margin-bottom: 0.75rem;
      border-left: 4px solid #5ED9A6;
    }

    .event-register-btn:hover {
      opacity: 0.85 !important;
      transform: translateY(-1px);
    }

    /* Jony Ive Mobile: Edge-to-edge Events f√ºr max content space */
    @media (max-width: 768px) {
      .event-list {
        margin: 0 -1.5rem; /* Pull out of .card padding */
      }

      .event-item {
        border-radius: 0; /* Edge-to-edge, kein border-radius */
        margin-bottom: 0;
        border-bottom: 1px solid rgba(0,0,0,0.06);
        padding: 1rem 1.5rem; /* Restored horizontal padding */
      }

      .event-item:last-child {
        border-bottom: none;
      }
    }

    .event-title {
      font-weight: 600;
      color: #2C3E50;
      margin-bottom: 0.25rem;
    }

    .event-date {
      font-size: 0.875rem;
      color: #6B6B6B;
    }

    .event-tentative-notice {
      color: #FF8C00;
      font-size: 0.875rem;
      margin-top: 0.5rem;
      font-weight: 500;
    }

    /* Loading Spinner */
    .loading {
      text-align: center;
      padding: 2rem;
      color: #6B6B6B;
    }

    .spinner {
      border: 4px solid rgba(94,217,166,0.2);
      border-top-color: #5ED9A6;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 1rem;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .empty-state {
      text-align: center;
      padding: 3rem 2rem;
      color: #999;
    }

    /* Profile Sub-Tabs */
    .profile-sub-tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 2rem;
      border-bottom: 2px solid rgba(0,0,0,0.08);
    }

    .profile-sub-tab {
      background: none;
      border: none;
      padding: 0.875rem 1.5rem;
      font-family: 'Work Sans', sans-serif;
      font-size: 0.9375rem;
      font-weight: 500;
      color: #6B6B6B;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      margin-bottom: -2px;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .profile-sub-tab:hover {
      color: #3A3A3A;
    }

    .profile-sub-tab.active {
      color: #2C3E50;
      font-weight: 600;
      border-bottom-color: #5ED9A6;
    }

    .profile-tab-section.hidden {
      display: none;
    }
  </style>

  <!-- Vercel Web Analytics -->
  <script defer src="/_vercel/insights/script.js"></script>
</head>
<body>
  <div class="container">
    <!-- KINN Logo -->
    <svg class="logo" viewBox="0 0 931.35 308.55" xmlns="http://www.w3.org/2000/svg">
      <polygon points="495.04 20.27 569.04 153.27 569.04 20.27 654.04 20.27 654.04 288.27 572.54 288.27 498.04 159.27 498.04 288.27 416.04 288.27 416.04 20.27 495.04 20.27"/>
      <path d="M682.04,20.27l78.89.11,73.11,133.89V20.27h81v268h-80l-72-130v130h-78.5c-.61,0-1.53-.8-2.5,0V20.27Z"/>
      <polygon points="100.04 20.27 100.04 136.27 160.54 20.27 256.04 20.27 182.26 145.61 262.04 288.27 166.54 288.27 100.04 159.27 100.04 288.27 21.04 288.27 21.04 20.27 100.04 20.27"/>
      <path d="M359.04,20.27v265.5c0,.31,1.37,1.42,1,2.5h-82V20.27h81Z"/>
    </svg>

    <!-- Dynamic Content -->
    <div id="content">
      <!-- Loading state -->
      <div class="loading">
        <div class="spinner"></div>
        <p>Profil wird geladen...</p>
      </div>
    </div>

    <!-- Footer -->
    <div class="footer">
      Wo Tiroler KI Profil bekommt
    </div>
  </div>

  <script type="module">
    // Import auth utilities for session support
    import {
      getSession,
      isSessionValid,
      getSessionToken,
      getUserEmail,
      saveSession
    } from '/public/js/auth.js';

    // Import Gravatar utilities
    import {
      getGravatarUrl,
      getInitialsAvatarUrl,
      createAvatarElement
    } from '/public/js/gravatar.js';

    // Extract token from URL (for direct links from emails) or session (for dashboard redirects)
    // Priority: Hash (magic links) ‚Üí Query params (legacy) ‚Üí Session (returning users)
    let token = null;
    let tokenEmail = null;
    let tokenSource = null; // Track where token came from for debugging

    // 1. Check Hash (from /api/auth/login redirect)
    try {
      const hash = window.location.hash.substring(1); // Remove #
      console.log('[PROFILE DEBUG] Raw hash:', hash ? `"${hash}"` : '(empty)');

      if (hash) {
        const hashParams = new URLSearchParams(hash);
        const hashToken = hashParams.get('token');
        const hashEmail = hashParams.get('email');

        console.log('[PROFILE DEBUG] Parsed from hash:', {
          hasToken: !!hashToken,
          tokenLength: hashToken?.length,
          hasEmail: !!hashEmail,
          email: hashEmail
        });

        if (hashToken) {
          token = hashToken;
          tokenEmail = hashEmail;
          tokenSource = 'hash (magic link)';
          console.log('[PROFILE] ‚úì Using hash token from magic link');

          // Check for section parameter (e.g., section=profil to navigate to profile tab)
          const hashSection = hashParams.get('section');
          if (hashSection) {
            console.log('[PROFILE] Section redirect requested:', hashSection);
            // Store in sessionStorage to apply after profile loads
            sessionStorage.setItem('kinn_redirect_section', hashSection);
          }

          // Save to BOTH localStorage AND sessionStorage for redundancy
          const sessionSaved = saveSession(token, tokenEmail);

          // Additional backup: sessionStorage (survives page reloads but not browser close)
          try {
            sessionStorage.setItem('kinn_backup_token', token);
            sessionStorage.setItem('kinn_backup_email', tokenEmail || '');
            console.log('[PROFILE] ‚úì Backup session saved to sessionStorage');
          } catch (err) {
            console.warn('[PROFILE] Failed to save backup session:', err);
          }

          if (!sessionSaved) {
            console.error('[PROFILE] ‚ö†Ô∏è Failed to save session to localStorage!');
            // Continue anyway - we have the token for this page load
          }

          // Clear hash to remove token from URL (security + UX)
          // Wait a tick to ensure session is persisted
          setTimeout(() => {
            // If there's a section redirect, use that as the new hash
            const redirectSection = sessionStorage.getItem('kinn_redirect_section');
            if (redirectSection) {
              window.history.replaceState(null, '', `${window.location.pathname}#${redirectSection}`);
              sessionStorage.removeItem('kinn_redirect_section');
              console.log('[PROFILE] Hash updated to section:', redirectSection);
            } else {
              window.history.replaceState(null, '', window.location.pathname);
              console.log('[PROFILE] Hash cleared from URL');
            }
          }, 100);
        }
      }
    } catch (error) {
      console.error('[PROFILE] Error parsing hash:', error);
    }

    // 2. Check Query params (legacy support)
    if (!token) {
      try {
        const params = new URLSearchParams(window.location.search);
        token = params.get('token');
        tokenEmail = params.get('email');
        if (token) {
          tokenSource = 'query params (legacy)';
          console.log('[PROFILE] ‚úì Using query param token (legacy)');
          saveSession(token, tokenEmail);
        }
      } catch (error) {
        console.error('[PROFILE] Error parsing query params:', error);
      }
    }

    // 3. Check Session (returning users - localStorage)
    if (!token && isSessionValid()) {
      token = getSessionToken();
      tokenEmail = getUserEmail();
      tokenSource = 'localStorage session';
      console.log('[PROFILE] ‚úì Using localStorage session token');
    }

    // 4. FALLBACK: Check sessionStorage backup (if localStorage failed)
    if (!token) {
      try {
        const backupToken = sessionStorage.getItem('kinn_backup_token');
        const backupEmail = sessionStorage.getItem('kinn_backup_email');

        if (backupToken) {
          token = backupToken;
          tokenEmail = backupEmail;
          tokenSource = 'sessionStorage backup';
          console.log('[PROFILE] ‚úì Using sessionStorage backup token');

          // Try to restore to localStorage
          saveSession(token, tokenEmail);
        }
      } catch (error) {
        console.error('[PROFILE] Error checking sessionStorage backup:', error);
      }
    }

    console.log('[PROFILE] Final token status:', {
      hasToken: !!token,
      source: tokenSource,
      email: tokenEmail
    });

    const content = document.getElementById('content');

    // State
    let userProfile = null;
    let userEmail = tokenEmail;
    let isSaving = false;

    // Determine active tab from URL hash (default: dashboard)
    // Note: Hash was cleared above if it contained token, so this checks for tab names only
    let activeTab = 'dashboard';
    const currentHash = window.location.hash.replace('#', '');
    if (currentHash === 'profil' || currentHash === 'settings') {
      activeTab = currentHash;
    }

    // Check for section redirect from magic link (stored in sessionStorage)
    const redirectSection = sessionStorage.getItem('kinn_redirect_section');
    if (redirectSection && (redirectSection === 'profil' || redirectSection === 'settings')) {
      activeTab = redirectSection;
      sessionStorage.removeItem('kinn_redirect_section');
      console.log('[PROFILE] Activating tab from redirect:', activeTab);
    }

    // Active domain filters (for skills filtering)
    // Progressive Disclosure: Start with Creative domain (41 skills) instead of All (147)
    let activeDomains = ['creative'];

    // Domain mapping for color-coded filters (Jony Ive inspired UX)
    const DOMAIN_MAPPING = {
      'creative': {
        emoji: 'üé®',
        label: 'Kreativ',
        color: '#9B87F5',
        categories: [
          'GENERATIVE KI - BILD',
          'GENERATIVE KI - VIDEO',
          'GENERATIVE KI - AUDIO & MUSIK',
          'GENERATIVE KI - 3D',
          'GENERATIVE KI - TEXT & CONTENT'
        ]
      },
      'language': {
        emoji: 'üí¨',
        label: 'Sprache',
        color: '#5ED9A6',
        categories: [
          'LLMs',
          'RAG & WISSENSSYSTEME',
          'NLP',
          'PROMPT ENGINEERING'
        ]
      },
      'vision': {
        emoji: 'üëÅÔ∏è',
        label: 'Vision',
        color: '#4A90E2',
        categories: [
          'COMPUTER VISION',
          'MULTIMODALE KI'
        ]
      },
      'engineering': {
        emoji: '‚öôÔ∏è',
        label: 'Engineering',
        color: '#6B7280',
        categories: [
          'MLOPS & DEPLOYMENT',
          'DATA ENGINEERING',
          'CLOUD & INFRASTRUKTUR',
          'PROGRAMMIERUNG',
          'KI-CODING & ENTWICKLUNG',
          'MACHINE LEARNING'
        ]
      },
      'applied': {
        emoji: 'üéØ',
        label: 'Anwendung',
        color: '#FF6B6B',
        categories: [
          'MARKETING KI',
          'CUSTOMER SERVICE KI',
          'KI-AGENTEN & AUTOMATION'
        ]
      },
      'research': {
        emoji: 'üî¨',
        label: 'Forschung',
        color: '#FBBF24',
        categories: [
          'KI-SICHERHEIT & ETHIK'
        ]
      }
    };

    // Reverse lookup: category ‚Üí domain
    const CATEGORY_TO_DOMAIN = {};
    Object.entries(DOMAIN_MAPPING).forEach(([domainKey, domainData]) => {
      domainData.categories.forEach(category => {
        CATEGORY_TO_DOMAIN[category] = {
          key: domainKey,
          ...domainData
        };
      });
    });

    // Available skills for selection (95 curated skills in 21 categories)
    const SKILLS_BY_CATEGORY = {
      'GENERATIVE KI - BILD': ['Midjourney', 'DALL-E', 'Stable Diffusion', 'ComfyUI', 'Adobe Firefly', 'Imagen', 'ControlNet', 'LoRA Training', 'Inpainting/Outpainting'],
      'GENERATIVE KI - VIDEO': ['Runway', 'Pika Labs', 'Sora', 'Google Veo', 'Stable Video', 'Luma AI', 'HeyGen', 'Synthesia', 'Lip Sync'],
      'GENERATIVE KI - AUDIO & MUSIK': ['Suno AI', 'Udio', 'ElevenLabs', 'Voice Cloning', 'Text-to-Speech', 'Speech-to-Text', 'Audio Enhancement', 'Stem Separation'],
      'GENERATIVE KI - 3D': ['Meshy AI', 'Luma AI Genie', 'NeRF', '3D Asset Generation'],
      'GENERATIVE KI - TEXT & CONTENT': ['ChatGPT', 'Claude', 'Gemini', 'Notion AI', 'Grammarly AI', 'Content Summarization'],
      'KI-CODING & ENTWICKLUNG': ['GitHub Copilot', 'Cursor', 'Claude Code', 'v0', 'Windsurf', 'Devin', 'Bolt.new', 'Replit AI', 'Code Review', 'Bug Detection', 'Code Refactoring', 'Test Generation', 'Documentation Generation'],
      'LLMs': ['GPT', 'Claude', 'Gemini', 'Llama', 'Mistral', 'LLM Fine-Tuning', 'Few-Shot Learning', 'Zero-Shot Learning', 'In-Context Learning', 'Token Optimization', 'Model Selection'],
      'PROMPT ENGINEERING': ['Prompt Design', 'Context Window Management', 'Few-Shot Prompting', 'Zero-Shot Prompting', 'Chain-of-Thought', 'ReAct Prompting', 'Tree of Thoughts', 'Prompt Chaining', 'Role Prompting', 'Prompt Templates', 'System Prompts'],
      'KI-AGENTEN & AUTOMATION': ['LangChain', 'LangGraph', 'CrewAI', 'AutoGPT', 'AutoGen', 'BabyAGI', 'Agentic RAG', 'Tool Use/Function Calling', 'Agent Orchestration', 'Workflow Automation', 'Task Decomposition', 'Human-in-the-Loop'],
      'RAG & WISSENSSYSTEME': ['RAG Architecture', 'Vector Databases', 'Embeddings', 'Semantic Search', 'Document Chunking', 'Hybrid Search', 'Knowledge Graphs', 'GraphRAG', 'Corrective RAG', 'Adaptive RAG', 'Multi-Vector Retrieval', 'Document Processing', 'Query Optimization'],
      'MACHINE LEARNING': ['Supervised Learning', 'Unsupervised Learning', 'Reinforcement Learning', 'Deep Learning', 'Neural Networks', 'Model Training', 'Feature Engineering', 'Model Evaluation', 'Transfer Learning', 'Hyperparameter Tuning', 'Ensemble Methods', 'Gradient Descent'],
      'COMPUTER VISION': ['OpenCV', 'YOLO', 'Object Detection', 'Image Segmentation', 'Semantic Segmentation', 'Pose Estimation', 'Facial Recognition', 'OCR', 'Image Classification', 'Action Recognition', 'Depth Estimation', 'Image Captioning'],
      'NLP': ['Transformers', 'BERT', 'Text Classification', 'Named Entity Recognition', 'Sentiment Analysis', 'Text Summarization', 'Question Answering', 'Machine Translation', 'Topic Modeling', 'Text Generation', 'Intent Classification', 'Speech Recognition'],
      'MLOPS & DEPLOYMENT': ['CI/CD for ML', 'Model Versioning', 'MLflow', 'Kubeflow', 'Docker', 'Kubernetes', 'Model Monitoring', 'A/B Testing', 'Feature Stores', 'Model Registry', 'Experiment Tracking', 'Model Serving', 'Model Drift Detection'],
      'DATA ENGINEERING': ['SQL', 'Data Warehousing', 'ETL/ELT Pipelines', 'Data Cleaning', 'Data Augmentation', 'Synthetic Data Generation', 'Data Labeling', 'Apache Spark', 'Apache Kafka', 'Data Lake Architecture', 'BigQuery/Snowflake', 'pandas/polars'],
      'MARKETING KI': ['Campaign Optimization', 'Personalization Engines', 'Customer Segmentation', 'Predictive Analytics'],
      'CUSTOMER SERVICE KI': ['Chatbots', 'Conversational AI', 'Virtual Assistants', 'Voice Assistants'],
      'MULTIMODALE KI': ['Vision-Language Models', 'Text-to-Image Understanding', 'Visual Question Answering', 'Image Captioning', 'Audio-Visual Learning', 'Document Understanding', 'Video Understanding', 'Cross-Modal Retrieval'],
      'KI-SICHERHEIT & ETHIK': ['AI Ethics', 'Bias Detection', 'Fairness Metrics', 'Explainable AI', 'AI Alignment', 'Red Teaming', 'AI Auditing', 'Adversarial Robustness', 'Privacy-Preserving ML', 'Model Governance'],
      'CLOUD & INFRASTRUKTUR': ['AWS SageMaker', 'Google Cloud Vertex AI', 'Azure ML', 'Hugging Face', 'CUDA', 'GPU Optimization', 'Distributed Training', 'Model Quantization'],
      'PROGRAMMIERUNG': ['Python', 'PyTorch', 'TensorFlow', 'JAX', 'scikit-learn', 'Hugging Face Transformers', 'Keras', 'NumPy']
    };

    // Flatten for easy iteration (backwards compatibility)
    const AVAILABLE_SKILLS = Object.values(SKILLS_BY_CATEGORY).flat();

    // Initialize
    (async function init() {
      if (!token) {
        console.error('[PROFILE] No token found after all fallback attempts!');
        console.error('[PROFILE] Token source:', tokenSource);
        console.error('[PROFILE] Hash on page load:', window.location.hash);
        console.error('[PROFILE] localStorage available:', typeof localStorage !== 'undefined');
        console.error('[PROFILE] sessionStorage available:', typeof sessionStorage !== 'undefined');

        showError(
          'Nicht eingeloggt',
          'Der Login-Link konnte nicht verarbeitet werden. Das kann verschiedene Gr√ºnde haben (Browser-Einstellungen, Cookies blockiert, etc.).',
          true // Show SOS contact info
        );
        return;
      }

      try {
        // Fetch user profile (extended with supply/demand data)
        const response = await fetch(`/api/profile/extended?token=${encodeURIComponent(token)}`);

        if (!response.ok) {
          if (response.headers.get('content-type')?.includes('text/html')) {
            // Branded error page - replace entire page
            const errorHTML = await response.text();
            document.open();
            document.write(errorHTML);
            document.close();
          } else {
            const error = await response.json();
            showError('Fehler beim Laden', error.message || 'Profil konnte nicht geladen werden.');
          }
          return;
        }

        const data = await response.json();
        userProfile = data.profile || {}; // The API returns { profile: {...}, preferences: {...} }

        // Save session to localStorage for persistence across page reloads
        const email = data.preferences?.email || data.profile?.email;
        userEmail = email; // Store email in state for dashboard rendering

        if (email && token) {
          saveSession(token, email);
          console.log('[PROFILE] Session saved for:', email);
        }

        // Handle URL hash for tab navigation
        window.addEventListener('hashchange', handleHashChange);

        // Render profile UI
        renderProfile();

      } catch (error) {
        console.error('[PROFILE] Error loading profile:', error);
        showError('Netzwerkfehler', 'Profil konnte nicht geladen werden. Bitte √ºberpr√ºfe deine Internetverbindung.');
      }
    })();

    function handleHashChange() {
      const hash = window.location.hash.replace('#', '');
      if (hash === 'dashboard' || hash === 'profil' || hash === 'settings') {
        activeTab = hash;
      } else {
        activeTab = 'dashboard';
      }
      renderProfile();

      // Load voting widget and radar widget when switching to dashboard
      // Note: Events now rendered via Luma embed (static iframe)
      if (activeTab === 'dashboard') {
        setTimeout(() => {
          loadVotingWidget();
          loadRadarEventsWidget();
        }, 100);
      }
    }

    // Make switchTab globally accessible for inline onclick handlers
    window.switchTab = function(tab) {
      activeTab = tab;
      window.location.hash = `#${tab}`;
      renderProfile();

      // Load widgets when switching to dashboard
      // Note: Events now rendered via Luma embed (static iframe)
      if (tab === 'dashboard') {
        setTimeout(() => {
          loadVotingWidget();
          loadRadarEventsWidget();
        }, 100);
      }
    }

    function renderProfile() {
      // Tab Navigation + Content based on active tab
      content.innerHTML = `
        <div id="avatarContainer" style="text-align: center;"></div>

        <h1>Mein KINN Profil</h1>
        <p class="subtitle">${userEmail || ''}</p>

        <!-- Tab Navigation -->
        <div class="tab-navigation">
          <button class="tab-button ${activeTab === 'dashboard' ? 'active' : ''}" onclick="switchTab('dashboard')">
            Dashboard
          </button>
          <button class="tab-button ${activeTab === 'profil' ? 'active' : ''}" onclick="switchTab('profil')">
            Mein Profil
          </button>
          <button class="tab-button ${activeTab === 'settings' ? 'active' : ''}" onclick="switchTab('settings')">
            <svg class="settings-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
              <path d="M10.325 4.317c.426 -1.756 2.924 -1.756 3.35 0a1.724 1.724 0 0 0 2.573 1.066c1.543 -.94 3.31 .826 2.37 2.37a1.724 1.724 0 0 0 1.065 2.572c1.756 .426 1.756 2.924 0 3.35a1.724 1.724 0 0 0 -1.066 2.573c.94 1.543 -.826 3.31 -2.37 2.37a1.724 1.724 0 0 0 -2.572 1.065c-.426 1.756 -2.924 1.756 -3.35 0a1.724 1.724 0 0 0 -2.573 -1.066c-1.543 .94 -3.31 -.826 -2.37 -2.37a1.724 1.724 0 0 0 -1.065 -2.572c-1.756 -.426 -1.756 -2.924 0 -3.35a1.724 1.724 0 0 0 1.066 -2.573c-.94 -1.543 .826 -3.31 2.37 -2.37c1 .608 2.296 .07 2.572 -1.065z"/>
              <path d="M9 12a3 3 0 1 0 6 0a3 3 0 0 0 -6 0"/>
            </svg>
            <span class="settings-text">Einstellungen</span>
          </button>
        </div>

        <div id="message"></div>

        <!-- Tab Content -->
        <div id="tab-content">
          ${activeTab === 'dashboard' ? renderDashboardTab() :
            activeTab === 'settings' ? renderSettingsTab() :
            renderProfilTab()}
        </div>
      `;

      // Inject Gravatar avatar with initials fallback
      const avatarContainer = document.getElementById('avatarContainer');
      if (avatarContainer && userEmail) {
        const userName = userProfile.identity?.name || (userEmail ? userEmail.split('@')[0] : 'User');
        const avatar = createAvatarElement(userEmail, userName, 80);
        avatarContainer.appendChild(avatar);
      }

      // Initialize skill counter after rendering
      setTimeout(() => updateSkillCounter(), 0);

      // Initialize sticky search scroll listener and keyboard shortcuts
      if (activeTab === 'profil') {
        setTimeout(() => {
          initializeStickySearch();
          initializeKeyboardShortcuts();
          applySkillFilters(); // Apply initial domain filter (Progressive Disclosure)

          // Restore active profile sub-tab from localStorage
          const savedTab = localStorage.getItem('kinn_profile_active_tab');
          if (savedTab && ['ich', 'angebot', 'suche'].includes(savedTab)) {
            switchProfileSubTab(savedTab);
          }
        }, 0);
      }

      // Load voting widget and radar widget on initial dashboard render
      // Note: Events now rendered via Luma embed (static iframe)
      if (activeTab === 'dashboard') {
        setTimeout(() => {
          loadVotingWidget();
          loadRadarEventsWidget();
        }, 100);
      }
    }

    // Make dismissWelcome available globally for onclick handlers
    window.dismissWelcome = function() {
      // Set localStorage flag
      localStorage.setItem('kinn_dashboard_intro_dismissed', 'true');

      // Animate fade-out
      const welcomeCard = document.getElementById('welcome-card');
      if (welcomeCard) {
        welcomeCard.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
        welcomeCard.style.opacity = '0';
        welcomeCard.style.transform = 'scale(0.95)';

        // Remove from DOM after animation
        setTimeout(() => {
          welcomeCard.remove();
        }, 300);
      }
    };

    function renderDashboardTab() {
      // Check if profile is complete
      const hasName = userProfile.identity?.name && userProfile.identity.name.trim() !== '';
      const hasSkills = userProfile.supply?.skills && userProfile.supply.skills.length > 0;
      const hasExperience = userProfile.supply?.experience;
      const isComplete = hasName && hasSkills && hasExperience;

      const userName = userProfile.identity?.name || (userEmail ? userEmail.split('@')[0] : 'User');

      // Check if user has dismissed the welcome intro
      const introDismissed = localStorage.getItem('kinn_dashboard_intro_dismissed') === 'true';

      // Welcome Card (community-first, dismissable)
      const welcomeCard = introDismissed ? '' : `
        <div class="card welcome-card" style="border-left: 4px solid #5ED9A6;" id="welcome-card">
          <button class="dismiss-btn" onclick="dismissWelcome()" aria-label="Schlie√üen">√ó</button>

          <h2>ü§ù Willkommen bei KINN!</h2>
          <p style="margin-bottom: 1.5rem;">KINN bringt AI Devs, Freelancer und Studenten in Tirol zusammen.</p>

          <div style="color: #666; line-height: 1.8; margin-bottom: 1.5rem;">
            ‚Üí Komm zum n√§chsten Stammtisch<br>
            ‚Üí Tausch dich mit Gleichgesinnten aus<br>
            ‚Üí Finde Projektpartner, Jobs oder Mentoren
          </div>

          <p style="font-size: 0.875rem; color: #999;">
            Optional: Profil ausf√ºllen f√ºr bessere Matches beim Event
          </p>
        </div>
      `;

      // Subtle profile hint (only if profile incomplete AND welcome dismissed)
      const profileHint = (introDismissed && !isComplete) ? `
        <div class="card" style="background: rgba(94, 217, 166, 0.05); border-left: 3px solid #5ED9A6;">
          <p style="margin-bottom: 1rem;">üí° <strong>Tipp:</strong> F√ºll dein Profil aus f√ºr bessere Matches beim Stammtisch</p>
          <button onclick="switchTab('profil')" class="cta-button" style="border: none; cursor: pointer; font-size: 0.875rem; padding: 0.75rem 1.5rem;">
            Zum Profil ‚Üí
          </button>
        </div>
      ` : '';

      return `
        ${welcomeCard}
        ${profileHint}

        <div class="card">
          <h2>Kommende Events & Tickets</h2>
          <div id="eventsContainer" style="margin-top: 1rem;">
            <iframe
              src="https://lu.ma/embed/calendar/cal-B8hLVGBZAUdaFkv/events?lt=light"
              width="100%"
              height="320"
              frameborder="0"
              style="border: 1px solid #bfcbda88; border-radius: 8px;"
              allowfullscreen=""
              aria-hidden="false"
              tabindex="0"
            ></iframe>
            <p style="font-size: 0.75rem; color: #999; margin-top: 0.5rem; text-align: center;">
              Events via <a href="https://luma.com/kinns" target="_blank" rel="noopener" style="color: #5ED9A6;">luma.com/kinns</a>
            </p>
          </div>
        </div>

        <!-- OLD Radar Events Widget - DISABLED, replaced by new calendar widget -->
        <!-- <div id="radar-events-widget" class="card" style="display: none;">
          <h2 style="font-size: 1.125rem; font-weight: 600; color: #2C3E50; margin-bottom: 0.75rem;">
            üöÄ AI & Tech Events in Tirol
            <span style="font-size: 0.75rem; color: #5ED9A6; font-weight: 400; margin-left: 0.5rem;">Radar</span>
          </h2>
          <p style="margin-bottom: 1rem; color: #6B6B6B; font-size: 0.875rem;">
            Entdecke weitere AI & Tech Events in der Region
          </p>
          <div id="radar-events-container" style="max-height: 420px; overflow-y: auto;">
            <div style="text-align: center; padding: 20px; color: #999;">
              <p style="font-size: 0.875rem;">Lade Events...</p>
            </div>
          </div>
        </div> -->

        <!-- NEW: KI Event Radar Calendar Widget (admin only for now) -->
        <div id="radar-calendar-widget" class="card" style="display: none;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h2 style="font-size: 1.125rem; font-weight: 600; color: #2C3E50; margin: 0;">
              KI Event Radar Tirol
            </h2>
            <span style="display: flex; gap: 0; align-items: center;">
              <button onclick="setUserRadarView('calendar')" id="user-radar-view-calendar" style="padding: 5px 12px; border: 1px solid #e5e7eb; border-radius: 10px 0 0 10px; background: #5ED9A6; color: white; font-size: 0.7rem; cursor: pointer; font-weight: 500;">Kalender</button>
              <button onclick="setUserRadarView('list')" id="user-radar-view-list" style="padding: 5px 12px; border: 1px solid #e5e7eb; border-left: none; border-radius: 0 10px 10px 0; background: white; color: #1F2937; font-size: 0.7rem; cursor: pointer; font-weight: 500;">Liste</button>
            </span>
          </div>

          <!-- Calendar View -->
          <div id="user-radar-calendar-view">
            <div id="user-radar-calendar-container" style="position: relative;">
              <div style="display: flex;">
                <div style="display: flex; flex-direction: column; gap: 3px; margin-right: 6px; font-size: 9px; color: #6B7280; font-weight: 500; padding-top: 18px;">
                  <div style="height: 18px; display: flex; align-items: center;">M</div>
                  <div style="height: 18px; display: flex; align-items: center;">D</div>
                  <div style="height: 18px; display: flex; align-items: center;">M</div>
                  <div style="height: 18px; display: flex; align-items: center;">D</div>
                  <div style="height: 18px; display: flex; align-items: center;">F</div>
                  <div style="height: 18px; display: flex; align-items: center;">S</div>
                  <div style="height: 18px; display: flex; align-items: center;">S</div>
                </div>
                <div id="user-radar-calendar-scroll" style="overflow-x: auto; overflow-y: hidden; flex: 1; scrollbar-width: thin;">
                  <div id="user-radar-month-labels" style="display: flex; margin-bottom: 3px; font-size: 9px; color: #6B7280; font-weight: 500; height: 14px;"></div>
                  <div id="user-radar-calendar-grid" style="display: flex; gap: 3px;"></div>
                </div>
              </div>
              <div style="text-align: center; margin-top: 6px; font-size: 9px; color: #9CA3AF;">‚Üê scroll ‚Üí</div>
              <div id="user-radar-day-detail" style="display: none; margin-top: 10px; padding: 10px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb; font-size: 0.875rem;"></div>
            </div>
            <div id="user-radar-calendar-legend" style="display: flex; flex-wrap: wrap; gap: 12px; margin-top: 10px; padding-top: 10px; border-top: 1px solid #e5e7eb; font-size: 10px; color: #4B5563;"></div>
          </div>

          <!-- List View (hidden by default) -->
          <div id="user-radar-list-view" style="display: none;">
            <div id="user-radar-list-content" style="max-height: 350px; overflow-y: auto;">
              <div style="padding: 20px; color: #9CA3AF; text-align: center;">Lade Events...</div>
            </div>
          </div>
        </div>

        <!-- KINN #7 Voting Widget -->
        <div class="card">
          <h2 style="font-size: 1.125rem; font-weight: 600; color: #2C3E50; margin-bottom: 0.75rem; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 0.5rem;">
            <span>
              Themen f√ºr KINN#7
              <span id="vote-count" style="font-size: 0.75rem; color: #999; font-weight: 400; margin-left: 0.5rem;"></span>
            </span>
            <a href="https://lu.ma/g09qnnud" class="luma-checkout--button" data-luma-action="checkout" data-luma-event-id="evt-HvWF9r2AsTYZygY" style="font-size: 0.75rem; font-weight: 500; padding: 0.25rem 0.75rem; background: #5ED9A6; color: #000; text-decoration: none; border-radius: 4px; cursor: pointer;">Anmelden</a>
          </h2>
          <p style="margin-bottom: 1rem; color: #6B6B6B; font-size: 0.875rem;">
            Vote f√ºr Themen, die dich beim n√§chsten Treff interessieren.
          </p>
          <div id="voting-widget-container">
            <div style="text-align: center; padding: 20px; color: #999;">
              <p style="font-size: 0.875rem;">Widget wird geladen...</p>
            </div>
          </div>
        </div>

        <!-- Discord Community Hint (subtle) -->
        <div style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; margin: 1.5rem 0;">
          <svg width="16" height="16" viewBox="0 0 71 55" fill="none" xmlns="http://www.w3.org/2000/svg" style="opacity: 0.4;">
            <path d="M60.1045 4.8978C55.5792 2.8214 50.7265 1.2916 45.6527 0.41542C45.5603 0.39851 45.468 0.440769 45.4204 0.525289C44.7963 1.6353 44.105 3.0834 43.6209 4.2216C38.1637 3.4046 32.7345 3.4046 27.3892 4.2216C26.905 3.0581 26.1886 1.6353 25.5617 0.525289C25.5141 0.443589 25.4218 0.40133 25.3294 0.41542C20.2584 1.2888 15.4057 2.8186 10.8776 4.8978C10.8384 4.9147 10.8048 4.9429 10.7825 4.9795C1.57795 18.7309 -0.943561 32.1443 0.293408 45.3914C0.299005 45.4562 0.335386 45.5182 0.385761 45.5576C6.45866 50.0174 12.3413 52.7249 18.1147 54.5195C18.2071 54.5477 18.305 54.5139 18.3638 54.4378C19.7295 52.5728 20.9469 50.6063 21.9907 48.5383C22.0523 48.4172 21.9935 48.2735 21.8676 48.2256C19.9366 47.4931 18.0979 46.6 16.3292 45.5858C16.1893 45.5041 16.1781 45.304 16.3068 45.2082C16.679 44.9293 17.0513 44.6391 17.4067 44.3461C17.471 44.2926 17.5606 44.2813 17.6362 44.3151C29.2558 49.6202 41.8354 49.6202 53.3179 44.3151C53.3935 44.2785 53.4831 44.2898 53.5502 44.3433C53.9057 44.6363 54.2779 44.9293 54.6529 45.2082C54.7816 45.304 54.7732 45.5041 54.6333 45.5858C52.8646 46.6197 51.0259 47.4931 49.0921 48.2228C48.9662 48.2707 48.9102 48.4172 48.9718 48.5383C50.038 50.6034 51.2554 52.5699 52.5959 54.435C52.6519 54.5139 52.7526 54.5477 52.845 54.5195C58.6464 52.7249 64.529 50.0174 70.6019 45.5576C70.6551 45.5182 70.6887 45.459 70.6943 45.3942C72.1747 30.0791 68.2147 16.7757 60.1968 4.9823C60.1772 4.9429 60.1437 4.9147 60.1045 4.8978ZM23.7259 37.3253C20.2276 37.3253 17.3451 34.1136 17.3451 30.1693C17.3451 26.225 20.1717 23.0133 23.7259 23.0133C27.308 23.0133 30.1626 26.2532 30.1066 30.1693C30.1066 34.1136 27.28 37.3253 23.7259 37.3253ZM47.3178 37.3253C43.8196 37.3253 40.9371 34.1136 40.9371 30.1693C40.9371 26.225 43.7636 23.0133 47.3178 23.0133C50.9 23.0133 53.7545 26.2532 53.6986 30.1693C53.6986 34.1136 50.9 37.3253 47.3178 37.3253Z" fill="#5865F2"/>
          </svg>
          <span style="font-size: 13px; color: #999; font-weight: 400; line-height: 1.5;">
            Teilnehmer vernetzen sich auf Discord
          </span>
        </div>

        <div class="card">
          <h2>Kalender abonnieren</h2>
          <p>Verpasse keinen KI Treff mehr - abonniere den KINN Event-Kalender.</p>
          <p class="meta" style="margin-bottom: 1.5rem;">
            Funktioniert mit Google Calendar, Apple Kalender und Outlook
          </p>
          <button onclick="subscribeToCalendar(event)" class="cta-button" style="border: none; cursor: pointer;">
            Kalender abonnieren
          </button>
        </div>
      `;
    }

    function renderSettingsTab() {
      const notificationsEnabled = userProfile.notifications?.enabled ?? true;

      return `
        <div class="card">
          <h2>Profilbild</h2>
          <p>Dein Avatar wird automatisch via <a href="https://gravatar.com" target="_blank" rel="noopener" style="color: #5ED9A6; text-decoration: underline;">Gravatar</a> geladen.</p>
          <p class="meta" style="margin-top: 0.5rem;">
            Kein Gravatar? Kein Problem - wir zeigen deine Initialen im KINN Design.
          </p>
        </div>

        <div class="card">
          <h2>Email-Benachrichtigungen</h2>
          <p>Verwalte, wie wir mit dir kommunizieren.</p>

          <div class="preference-row">
            <div>
              <div class="preference-label">Event-Benachrichtigungen</div>
              <div class="preference-description">Erhalte Emails √ºber neue KI Treffs</div>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="notificationsToggle" ${notificationsEnabled ? 'checked' : ''} onchange="handleToggleChange(this)">
              <span class="toggle-slider"></span>
            </label>
          </div>
        </div>

        <div class="card">
          <h2>Kalender-Abonnement</h2>
          <p>Events automatisch in deinem Kalender anzeigen.</p>
          <p class="meta">Google Calendar, Apple Kalender und Outlook</p>
        </div>

        <button onclick="subscribeToCalendar(event)" class="cta-button" style="border: none; cursor: pointer;">
          Kalender abonnieren
        </button>

        <button onclick="handleUnsubscribe()" class="cta-button danger-button" style="margin-top: 2rem;">
          Komplett abmelden
        </button>

        <p class="meta" style="margin-top: 1rem; text-align: center;">
          Angemeldet seit: ${new Date(userProfile.subscribedAt || Date.now()).toLocaleDateString('de-DE', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
          })}
        </p>

        <!-- Jony Ive approved: Ultra-subtle troubleshooting -->
        <div class="troubleshoot-hint" style="margin-top: 3rem; text-align: center; opacity: 0.4; transition: opacity 0.3s;">
          <button onclick="gentleRefresh()" class="gentle-refresh">Probleme mit der Anzeige?</button>
        </div>
      `;
    }

    function renderProfilTab() {
      const identity = userProfile.identity || {};
      const supply = userProfile.supply || {};
      const demand = userProfile.demand || {};
      const privacy = userProfile.preferences?.privacy || {};

      return `
        <div class="card">
          <h2>Zeit sparen beim Stammtisch</h2>
          <p>F√ºll dein Profil aus und wir k√∂nnen dich schon vorab mit passenden Leuten matchen.</p>

          <!-- Profile Sub-Tabs -->
          <div class="profile-sub-tabs">
            <button type="button" class="profile-sub-tab active" data-tab="ich" onclick="switchProfileSubTab('ich')">
              Ich
            </button>
            <button type="button" class="profile-sub-tab" data-tab="angebot" onclick="switchProfileSubTab('angebot')">
              Angebot
            </button>
            <button type="button" class="profile-sub-tab" data-tab="suche" onclick="switchProfileSubTab('suche')">
              Suche
            </button>
          </div>

          <form id="profileForm" onsubmit="handleProfileSubmit(event)">
            <!-- Tab: Ich -->
            <div class="profile-tab-section" data-tab="ich">
            <!-- Section: Basis-Info -->
            <div class="form-group">
              <label class="form-label">Name</label>
              <input type="text" class="form-input" name="name" value="${identity.name || ''}" placeholder="Dein Name">
            </div>

            <div class="form-group">
              <label class="form-label">LinkedIn Profil</label>
              <input type="url" class="form-input" name="linkedIn" value="${identity.linkedIn || ''}" placeholder="https://linkedin.com/in/...">
            </div>

            <div class="form-group">
              <label class="form-label">GitHub (optional)</label>
              <input type="url" class="form-input" name="github" value="${identity.github || ''}" placeholder="https://github.com/...">
            </div>

            <div class="form-group">
              <label class="form-label">Portfolio / Website (optional)</label>
              <input type="url" class="form-input" name="portfolio" value="${identity.portfolio || ''}" placeholder="https://...">
            </div>

            <div class="form-group">
              <label class="form-label">Event-Pr√§ferenz</label>
              <p class="form-help" style="font-size: 0.875rem; color: #6B6B6B; margin-top: 0.25rem; margin-bottom: 0.75rem;">
                Welche Events m√∂chtest du besuchen?
              </p>
              <select class="form-select" name="location">
                <option value="">Bitte w√§hlen...</option>
                <option value="in-person" ${['ibk', 'tirol', 'in-person'].includes(identity.location) ? 'selected' : ''}>Pr√§senz in Tirol</option>
                <option value="online" ${identity.location === 'online' || identity.location === 'remote' ? 'selected' : ''}>Online / Remote</option>
                <option value="all" ${identity.location === 'hybrid' || identity.location === 'all' ? 'selected' : ''}>Beides (flexibel)</option>
              </select>
            </div>
            </div>
            <!-- End Tab: Ich -->

            <!-- Tab: Angebot -->
            <div class="profile-tab-section hidden" data-tab="angebot">
            <div class="form-group">
              <label class="form-label">Erfahrung</label>
              <div class="radio-group">
                <div class="radio-option">
                  <input type="radio" id="exp-junior" name="experience" value="junior" ${supply.experience === 'junior' ? 'checked' : ''}>
                  <label for="exp-junior">Junior</label>
                </div>
                <div class="radio-option">
                  <input type="radio" id="exp-mid" name="experience" value="mid" ${supply.experience === 'mid' ? 'checked' : ''}>
                  <label for="exp-mid">Mid-Level</label>
                </div>
                <div class="radio-option">
                  <input type="radio" id="exp-senior" name="experience" value="senior" ${supply.experience === 'senior' ? 'checked' : ''}>
                  <label for="exp-senior">Senior</label>
                </div>
                <div class="radio-option">
                  <input type="radio" id="exp-lead" name="experience" value="lead" ${supply.experience === 'lead' ? 'checked' : ''}>
                  <label for="exp-lead">Lead / Expert</label>
                </div>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">Meine aktuelle Situation</label>
              <p class="form-help" style="font-size: 0.875rem; color: #6B6B6B; margin-top: 0.25rem; margin-bottom: 0.75rem;">
                Beschreib wo du gerade stehst. Was du suchst kommt weiter unten.
              </p>
              <div class="radio-group">
                <div class="radio-option">
                  <input type="radio" id="avail-employed" name="availability" value="employed" ${['fulltime', 'employed', 'passive'].includes(supply.availability) ? 'checked' : ''}>
                  <label for="avail-employed">Vollzeit angestellt</label>
                </div>
                <div class="radio-option">
                  <input type="radio" id="avail-freelancer" name="availability" value="freelancer" ${['freelance', 'freelancer'].includes(supply.availability) ? 'checked' : ''}>
                  <label for="avail-freelancer">Freelancer / Selbstst√§ndig</label>
                </div>
                <div class="radio-option">
                  <input type="radio" id="avail-student" name="availability" value="student" ${supply.availability === 'student' ? 'checked' : ''}>
                  <label for="avail-student">Student / Lernend</label>
                </div>
                <div class="radio-option">
                  <input type="radio" id="avail-between-jobs" name="availability" value="between-jobs" ${supply.availability === 'between-jobs' ? 'checked' : ''}>
                  <label for="avail-between-jobs">Zwischen Jobs</label>
                </div>
                <div class="radio-option">
                  <input type="radio" id="avail-side-projects" name="availability" value="side-projects" ${['sideproject', 'side-projects'].includes(supply.availability) ? 'checked' : ''}>
                  <label for="avail-side-projects">Side Projects / Hobbies</label>
                </div>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">Ich biete an</label>
              <div class="checkbox-group">
                <div class="checkbox-option">
                  <input type="checkbox" id="offer-mentoring" name="canOffer" value="mentoring" ${(supply.canOffer || []).includes('mentoring') ? 'checked' : ''}>
                  <label for="offer-mentoring">Mentoring</label>
                </div>
                <div class="checkbox-option">
                  <input type="checkbox" id="offer-codereview" name="canOffer" value="code-review" ${(supply.canOffer || []).includes('code-review') ? 'checked' : ''}>
                  <label for="offer-codereview">Code Review</label>
                </div>
                <div class="checkbox-option">
                  <input type="checkbox" id="offer-workshop" name="canOffer" value="workshop" ${(supply.canOffer || []).includes('workshop') ? 'checked' : ''}>
                  <label for="offer-workshop">Workshop halten</label>
                </div>
                <div class="checkbox-option">
                  <input type="checkbox" id="offer-projects" name="canOffer" value="projects" ${(supply.canOffer || []).includes('projects') ? 'checked' : ''}>
                  <label for="offer-projects">Projekte vorstellen</label>
                </div>
              </div>
            </div>

            <div style="margin: 2rem 0; padding: 1rem; background: rgba(94, 217, 166, 0.08); border-radius: 8px;">
              <p style="margin: 0; color: #2C3E50; font-weight: 500;">
                üí° Fast geschafft! W√§hle jetzt deine Top-Skills aus, damit wir dich mit den richtigen Leuten matchen k√∂nnen.
              </p>
            </div>

            <div class="form-group">
              <label class="form-label" style="display: flex; align-items: center; justify-content: space-between;">
                <span>Skills (klicken zum ausw√§hlen)</span>
                <span id="skillCounter" class="low">0/20</span>
              </label>

              <!-- Selected Skills Bar -->
              <div id="selectedSkillsBar" class="empty">
                <span style="opacity: 0.7;">‚ú® W√§hle bis zu 20 Skills aus</span>
              </div>

              <!-- Sticky Search Container -->
              <div class="skills-search-container">
                <div style="position: relative;">
                  <input
                    type="text"
                    id="skillSearch"
                    placeholder="üîç Suche in 95 Skills..."
                    class="form-input"
                    style="width: 100%; padding: 0.875rem 1rem; font-size: 0.9375rem;"
                    oninput="filterSkills(this.value)"
                  />
                </div>
              </div>

              <!-- Domain Filters (Apple-inspired) -->
              <div class="domain-filters">
                <button type="button" class="domain-chip ${activeDomains.includes('all') ? 'active' : ''}" data-domain="all" onclick="toggleDomainFilter('all')">
                  Alle <span class="count">95</span>
                </button>
                ${Object.entries(DOMAIN_MAPPING).map(([domainKey, domain]) => {
                  const skillCount = domain.categories.reduce((sum, cat) => {
                    return sum + (SKILLS_BY_CATEGORY[cat]?.length || 0);
                  }, 0);
                  const isActive = activeDomains.includes(domainKey);
                  return `
                    <button
                      type="button"
                      class="domain-chip ${isActive ? 'active' : ''}"
                      data-domain="${domainKey}"
                      style="--domain-color: ${domain.color}"
                      onclick="toggleDomainFilter('${domainKey}')"
                    >
                      ${domain.emoji} ${domain.label} <span class="count">${skillCount}</span>
                    </button>
                  `;
                }).join('')}
              </div>

              <!-- Flat Skill Grid -->
              <div id="skillsContainer" class="skills-grid">
                ${Object.entries(SKILLS_BY_CATEGORY).map(([category, skills]) => {
                  const domainInfo = CATEGORY_TO_DOMAIN[category];
                  const domainColor = domainInfo?.color || '#6B7280';
                  const domainKey = domainInfo?.key || 'other';

                  return skills.map(skill => `
                    <div
                      class="chip ${(supply.skills || []).includes(skill.toLowerCase()) ? 'selected' : ''}"
                      data-skill="${skill.toLowerCase()}"
                      data-skill-label="${skill}"
                      data-domain="${domainKey}"
                      data-category="${category}"
                      style="--domain-color: ${domainColor}"
                      onclick="toggleSkill(this)"
                    >
                      ${skill}
                    </div>
                  `).join('');
                }).join('')}
              </div>
            </div>
            </div>
            <!-- End Tab: Angebot -->

            <!-- Tab: Suche -->
            <div class="profile-tab-section hidden" data-tab="suche">
            <div class="form-group">
              <label class="form-label">Offen f√ºr</label>
              <div class="checkbox-group">
                <div class="checkbox-option">
                  <input type="checkbox" id="seek-job" name="seeking" value="job" ${(demand.seeking || []).includes('job') ? 'checked' : ''}>
                  <label for="seek-job">Vollzeit Job</label>
                </div>
                <div class="checkbox-option">
                  <input type="checkbox" id="seek-freelance" name="seeking" value="freelance" ${(demand.seeking || []).includes('freelance') ? 'checked' : ''}>
                  <label for="seek-freelance">Freelance Gigs</label>
                </div>
                <div class="checkbox-option">
                  <input type="checkbox" id="seek-cofounder" name="seeking" value="cofounder" ${(demand.seeking || []).includes('cofounder') ? 'checked' : ''}>
                  <label for="seek-cofounder">Co-Founder</label>
                </div>
                <div class="checkbox-option">
                  <input type="checkbox" id="seek-collaboration" name="seeking" value="collaboration" ${(demand.seeking || []).includes('collaboration') ? 'checked' : ''}>
                  <label for="seek-collaboration">Collaboration</label>
                </div>
                <div class="checkbox-option">
                  <input type="checkbox" id="seek-learning" name="seeking" value="learning" ${(demand.seeking || []).includes('learning') ? 'checked' : ''}>
                  <label for="seek-learning">Learning / Mentorship</label>
                </div>
                <div class="checkbox-option">
                  <input type="checkbox" id="seek-inspiration" name="seeking" value="inspiration" ${(demand.seeking || []).includes('inspiration') ? 'checked' : ''}>
                  <label for="seek-inspiration">Inspiration / Austausch</label>
                </div>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">Wie aktiv?</label>
              <div class="radio-group">
                <div class="radio-option">
                  <input type="radio" id="search-active" name="activeSearch" value="active" ${demand.activeSearch === 'active' || demand.activeSearch === true ? 'checked' : ''}>
                  <label for="search-active">Aktiv suchend (bewerbe mich gerade)</label>
                </div>
                <div class="radio-option">
                  <input type="radio" id="search-passive" name="activeSearch" value="passive" ${demand.activeSearch === 'passive' ? 'checked' : ''}>
                  <label for="search-passive">Passiv offen (h√∂re mir Angebote an)</label>
                </div>
                <div class="radio-option">
                  <input type="radio" id="search-networking" name="activeSearch" value="networking-only" ${demand.activeSearch === 'networking-only' || demand.activeSearch === false ? 'checked' : ''}>
                  <label for="search-networking">Nur Networking (nichts Konkretes)</label>
                </div>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">Spezifische Interessen (optional)</label>
              <textarea class="form-textarea" name="interests" placeholder="z.B. Suche Co-Founder f√ºr Healthcare AI Startup, interessiert an LLM Fine-tuning, etc.">${demand.interests || ''}</textarea>
            </div>

            <hr class="section-divider">

            <!-- Section: Privacy -->
            <h2 style="margin-bottom: 1rem;">Privacy</h2>

            <div class="checkbox-group">
              <div class="checkbox-option">
                <input type="checkbox" id="privacy-directory" name="showInDirectory" ${privacy.showInDirectory ? 'checked' : ''}>
                <label for="privacy-directory">Im KINN Verzeichnis anzeigen (√∂ffentlich)</label>
              </div>
              <div class="checkbox-option">
                <input type="checkbox" id="privacy-matching" name="allowMatching" ${privacy.allowMatching ? 'checked' : ''}>
                <label for="privacy-matching">Automatisches Matching erlauben</label>
              </div>
            </div>
            </div>
            <!-- End Tab: Suche -->

            <!-- Submit Button (always visible) -->
            <button type="submit" class="cta-button" style="margin-top: 2rem;">
              Profil speichern
            </button>
          </form>

          <!-- Match Hints (populated after save) -->
          <div id="matchHintsContainer"></div>
        </div>

        <a href="/" class="cta-button secondary-button">
          Zur Startseite
        </a>
      `;
    }

    // Skill chip toggle
    // Make globally accessible for inline onclick handlers
    window.toggleSkill = function(chip) {
      const skillDataValue = chip.getAttribute('data-skill');
      const isCurrentlySelected = chip.classList.contains('selected');

      if (isCurrentlySelected) {
        // Deselect all chips with this skill (handles duplicates across categories)
        document.querySelectorAll(`.chip[data-skill="${skillDataValue}"]`).forEach(c => {
          c.classList.remove('selected');
        });
      } else {
        // Check selection limit (count unique skills in grid only, NOT selected bar!)
        const uniqueSelectedSkills = new Set(
          Array.from(document.querySelectorAll('#skillsContainer .chip.selected'))
            .map(c => c.getAttribute('data-skill'))
        );

        if (uniqueSelectedSkills.size >= 20) {
          alert('‚ö†Ô∏è Maximal 20 Skills erlaubt. Bitte entferne zuerst andere Skills.');
          return;
        }

        // Select all chips with this skill (sync across duplicates)
        document.querySelectorAll(`.chip[data-skill="${skillDataValue}"]`).forEach(c => {
          c.classList.add('selected');
        });
      }

      updateSkillCounter();
      autoSaveSkills(); // Auto-save nach jedem Toggle
    }

    // Remove skill from selected bar
    window.removeSelectedSkill = function(skillDataValue) {
      // Remove all chips with this skill (handles duplicates across categories)
      const chips = document.querySelectorAll(`.chip[data-skill="${skillDataValue}"]`);
      chips.forEach(chip => {
        chip.classList.remove('selected');
      });
      updateSkillCounter();
      autoSaveSkills(); // Auto-save nach Entfernen
    }

    // Profile sub-tab switching
    window.switchProfileSubTab = function(tabName) {
      // Update button states
      document.querySelectorAll('.profile-sub-tab').forEach(btn => {
        if (btn.getAttribute('data-tab') === tabName) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      });

      // Show/hide tab sections
      document.querySelectorAll('.profile-tab-section').forEach(section => {
        if (section.getAttribute('data-tab') === tabName) {
          section.classList.remove('hidden');
        } else {
          section.classList.add('hidden');
        }
      });

      // Save to localStorage
      localStorage.setItem('kinn_profile_active_tab', tabName);
    };

    // Render KINN #7 Voting Tab

    // Load voting widget
    let votingWidgetCleanup = null;

    async function loadVotingWidget() {
      const container = document.getElementById('voting-widget-container');
      if (!container) return;

      // Clean up previous instance if exists
      if (votingWidgetCleanup) {
        votingWidgetCleanup();
        votingWidgetCleanup = null;
      }

      try {
        // Dynamically import the voting widget module
        const { initVotingWidget } = await import('/js/voting-widget.js');

        // Get the auth token
        const authToken = localStorage.getItem('authToken') || token;

        if (!authToken) {
          container.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #ff4444;">
              <p>Kein Auth-Token gefunden. Bitte neu einloggen.</p>
            </div>
          `;
          return;
        }

        // Initialize the widget
        votingWidgetCleanup = initVotingWidget(container, authToken);

        console.log('[VOTING] Widget initialized');

      } catch (error) {
        console.error('[VOTING] Failed to load widget:', error);
        container.innerHTML = `
          <div style="text-align: center; padding: 40px; color: #ff4444;">
            <p>Widget konnte nicht geladen werden.</p>
            <p style="font-size: 12px; margin-top: 8px;">${error.message}</p>
          </div>
        `;
      }
    }

    // Auto-save skills to Redis (instant save, no form submit needed)
    async function autoSaveSkills() {
      if (!token) return;

      try {
        // Get currently selected skills (deduplicated)
        const selectedSkills = [...new Set(
          Array.from(document.querySelectorAll('#skillsContainer .chip.selected'))
            .map(chip => chip.dataset.skill)
        )];

        // Save to server
        const response = await fetch('/api/profile/update-skills', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            token,
            skills: selectedSkills
          })
        });

        if (!response.ok) {
          console.error('[AUTO-SAVE] Failed to save skills:', response.statusText);
        } else {
          console.log('[AUTO-SAVE] Skills saved:', selectedSkills.length);
        }
      } catch (error) {
        console.error('[AUTO-SAVE] Error saving skills:', error);
      }
    }

    function updateSkillCounter() {
      const selectedChips = document.querySelectorAll('#skillsContainer .chip.selected');
      const counter = document.getElementById('skillCounter');
      const selectedBar = document.getElementById('selectedSkillsBar');

      // Count UNIQUE selected skills (not total chips - handles duplicates)
      const uniqueSelectedSkills = new Set(
        Array.from(selectedChips).map(chip => chip.getAttribute('data-skill'))
      );
      const uniqueCount = uniqueSelectedSkills.size;

      if (counter) {
        counter.textContent = `${uniqueCount}/20`;

        // Apply color classes based on unique count
        counter.classList.remove('low', 'medium', 'high');
        if (uniqueCount >= 19) {
          counter.classList.add('high');
        } else if (uniqueCount >= 11) {
          counter.classList.add('medium');
        } else {
          counter.classList.add('low');
        }
      }

      // Populate selected skills bar (deduplicated)
      if (selectedBar) {
        if (selectedChips.length === 0) {
          selectedBar.innerHTML = '<span style="opacity: 0.7; font-size: 0.875rem;">‚ú® W√§hle bis zu 20 Skills aus</span>';
        } else {
          // Deduplicate by data-skill value
          const uniqueSkills = new Map();
          selectedChips.forEach(chip => {
            const skillDataValue = chip.getAttribute('data-skill');
            if (!uniqueSkills.has(skillDataValue)) {
              const skillName = chip.getAttribute('data-skill-label') || chip.textContent.trim();
              uniqueSkills.set(skillDataValue, skillName);
            }
          });

          selectedBar.innerHTML = Array.from(uniqueSkills.entries()).map(([skillValue, skillName]) => `
            <div class="chip selected">
              ${skillName}
              <button class="chip-remove" onclick="removeSelectedSkill('${skillValue}')" title="Entfernen">√ó</button>
            </div>
          `).join('');

          // Check if content is scrollable and show fade gradient (Apple-style)
          setTimeout(() => {
            if (selectedBar.scrollHeight > selectedBar.clientHeight) {
              selectedBar.classList.add('has-overflow');
            } else {
              selectedBar.classList.remove('has-overflow');
            }
          }, 0);
        }
      }
    }

    function initializeStickySearch() {
      const searchContainer = document.querySelector('.skills-search-container');
      if (!searchContainer) return;

      // Track initial position
      const initialTop = searchContainer.getBoundingClientRect().top + window.scrollY;

      // Add scroll event listener
      const handleScroll = () => {
        const scrollTop = window.scrollY;

        if (scrollTop > initialTop) {
          // Add sticky styling when scrolled past initial position
          searchContainer.style.borderColor = 'rgba(94, 217, 166, 0.3)';
          searchContainer.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.08)';
        } else {
          // Remove sticky styling when at or above initial position
          searchContainer.style.borderColor = 'transparent';
          searchContainer.style.boxShadow = 'none';
        }
      };

      // Initial check
      handleScroll();

      // Attach listener
      window.addEventListener('scroll', handleScroll);
    }

    // Keyboard shortcuts (Apple-inspired)
    function initializeKeyboardShortcuts() {
      document.addEventListener('keydown', (e) => {
        // ESC: Clear all filters
        if (e.key === 'Escape') {
          const searchInput = document.getElementById('skillSearch');
          if (searchInput && searchInput.value) {
            searchInput.value = '';
            applySkillFilters();
          }
          if (!activeDomains.includes('all')) {
            toggleDomainFilter('all');
          }
        }

        // CMD/CTRL + K: Focus search
        if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
          e.preventDefault();
          const searchInput = document.getElementById('skillSearch');
          if (searchInput) {
            searchInput.focus();
            searchInput.select();
          }
        }
      });
    }

    // Domain filter toggle (Apple-inspired interaction)
    window.toggleDomainFilter = function(domainKey) {
      const allDomainChips = document.querySelectorAll('.domain-chip');

      if (domainKey === 'all') {
        // Select 'all' - deselect everything else
        activeDomains = ['all'];
      } else {
        // Toggle specific domain
        if (activeDomains.includes('all')) {
          // If 'all' was selected, replace it with this domain
          activeDomains = [domainKey];
        } else if (activeDomains.includes(domainKey)) {
          // Deselect this domain
          activeDomains = activeDomains.filter(d => d !== domainKey);
          // If nothing selected, revert to 'all'
          if (activeDomains.length === 0) {
            activeDomains = ['all'];
          }
        } else {
          // Add this domain to selection
          activeDomains.push(domainKey);
        }
      }

      // Update UI: active states on domain chips
      allDomainChips.forEach(chip => {
        const chipDomain = chip.getAttribute('data-domain');
        if (activeDomains.includes(chipDomain)) {
          chip.classList.add('active');
        } else {
          chip.classList.remove('active');
        }
      });

      // Apply domain filtering to skills
      applySkillFilters();
    }

    // Apply both search and domain filters
    function applySkillFilters() {
      const searchInput = document.getElementById('skillSearch');
      const searchTerm = searchInput ? searchInput.value.toLowerCase().trim() : '';
      const allSkillChips = document.querySelectorAll('.skills-grid .chip');

      allSkillChips.forEach(chip => {
        const skillLabel = (chip.getAttribute('data-skill-label') || chip.textContent).toLowerCase();
        const chipDomain = chip.getAttribute('data-domain');

        // Check search match
        const matchesSearch = !searchTerm || skillLabel.includes(searchTerm);

        // Check domain match
        const matchesDomain = activeDomains.includes('all') || activeDomains.includes(chipDomain);

        // Show chip only if it matches both filters
        if (matchesSearch && matchesDomain) {
          chip.classList.remove('hidden');
        } else {
          chip.classList.add('hidden');
        }
      });
    }

    window.filterSkills = function(searchTerm) {
      applySkillFilters();
    }

    // Profile form submission
    window.handleProfileSubmit = async function(event) {
      event.preventDefault();

      if (isSaving) return;
      isSaving = true;

      const form = event.target;
      const formData = new FormData(form);

      // Build profile data object
      const profileData = {
        identity: {
          name: formData.get('name'),
          linkedIn: formData.get('linkedIn'),
          github: formData.get('github'),
          portfolio: formData.get('portfolio'),
          location: formData.get('location')
        },
        supply: {
          skills: [...new Set(
            Array.from(document.querySelectorAll('#skillsContainer .chip.selected'))
              .map(chip => chip.dataset.skill)
          )],
          experience: formData.get('experience'),
          availability: formData.get('availability'),
          canOffer: formData.getAll('canOffer')
        },
        demand: {
          seeking: formData.getAll('seeking'),
          industries: formData.getAll('industries'),
          activeSearch: formData.get('activeSearch') === 'true',
          interests: formData.get('interests')
        },
        preferences: {
          privacy: {
            showInDirectory: formData.get('showInDirectory') === 'on',
            allowMatching: formData.get('allowMatching') === 'on'
          }
        }
      };

      try {
        const response = await fetch('/api/profile/update-extended', {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            token,
            ...profileData
          })
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.message || 'Update fehlgeschlagen');
        }

        const data = await response.json();
        userProfile = data.profile;

        // Show success message
        showMessage('success', 'Profil erfolgreich gespeichert!');

        // Show match hints if available
        if (data.matches && data.matches.hints && data.matches.hints.length > 0) {
          const hintsContainer = document.getElementById('matchHintsContainer');
          if (hintsContainer) {
            hintsContainer.innerHTML = `
              <div class="match-hints">
                <h3>Match-Potential</h3>
                <ul>
                  ${data.matches.hints.map(hint => `<li>${hint}</li>`).join('')}
                </ul>
              </div>
            `;
          }
        }

        // Scroll to top to see success message
        window.scrollTo({ top: 0, behavior: 'smooth' });

      } catch (error) {
        console.error('[PROFILE] Error updating profile:', error);
        showMessage('error', 'Profil konnte nicht gespeichert werden. Bitte versuche es erneut.');
      } finally {
        isSaving = false;
      }
    }

    // Make globally accessible for inline onchange handlers
    window.handleToggleChange = async function(checkbox) {
      if (isSaving) return;

      const newValue = checkbox.checked;
      isSaving = true;

      try {
        const response = await fetch('/api/profile/update', {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            token,
            notifications: {
              enabled: newValue
            }
          })
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.message || 'Update fehlgeschlagen');
        }

        const data = await response.json();
        userProfile = data.preferences;

        // Show success message
        showMessage('success', newValue
          ? 'Benachrichtigungen aktiviert'
          : 'Benachrichtigungen deaktiviert'
        );

      } catch (error) {
        console.error('[PROFILE] Error updating preferences:', error);
        // Revert checkbox
        checkbox.checked = !newValue;
        showMessage('error', '√Ñnderung fehlgeschlagen. Bitte versuche es erneut.');
      } finally {
        isSaving = false;
      }
    }

    // Make globally accessible for inline onclick handlers
    window.handleUnsubscribe = async function() {
      if (!confirm('M√∂chtest du dich wirklich komplett vom KINN KI Treff abmelden? Diese Aktion kann nicht r√ºckg√§ngig gemacht werden.')) {
        return;
      }

      try {
        const response = await fetch('/api/profile/unsubscribe', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ token })
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.message || 'Abmeldung fehlgeschlagen');
        }

        // Show success and redirect
        content.innerHTML = `
          <div class="status-indicator">
            <svg viewBox="0 0 24 24">
              <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
          </div>

          <h1>Erfolgreich abgemeldet</h1>
          <p class="subtitle">Du wurdest vom KINN KI Treff abgemeldet.</p>

          <div class="success-message">
            Deine Email-Adresse wurde aus unserer Liste entfernt. Du erh√§ltst keine weiteren Benachrichtigungen.
          </div>

          <a href="/" class="cta-button">
            Zur Startseite
          </a>
        `;

      } catch (error) {
        console.error('[PROFILE] Error unsubscribing:', error);
        showMessage('error', 'Abmeldung fehlgeschlagen. Bitte versuche es erneut.');
      }
    }

    // Jony Ive approved: Gentle cache refresh - SLC principle
    window.gentleRefresh = function() {
      // First principles: What's the minimum needed to fix cache issues?
      // Answer: Clear storage + reload. Nothing more.

      // Subtle feedback before action
      const button = event.target;
      const originalText = button.textContent;
      button.textContent = 'Aktualisiere...';
      button.style.opacity = '0.6';

      // Give user a moment to see the feedback
      setTimeout(() => {
        // Clear all local caches
        try {
          localStorage.clear();
          sessionStorage.clear();

          // Clear service worker caches if present
          if ('caches' in window) {
            caches.keys().then(names => {
              names.forEach(name => caches.delete(name));
            });
          }

          // Clear any service workers
          if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(registrations => {
              registrations.forEach(registration => registration.unregister());
            });
          }
        } catch (e) {
          console.log('[CACHE] Clear error:', e);
        }

        // Gentle reload after clearing
        setTimeout(() => {
          location.reload(true);
        }, 100);
      }, 300);
    }

    function showMessage(type, text) {
      const messageDiv = document.getElementById('message');
      if (!messageDiv) return;

      const className = type === 'success' ? 'success-message' : 'error-message';
      messageDiv.innerHTML = `<div class="${className}">${text}</div>`;

      // Auto-hide after 3 seconds
      setTimeout(() => {
        messageDiv.innerHTML = '';
      }, 3000);
    }

    function showError(title, message, showSOS = false) {
      content.innerHTML = `
        <div class="status-indicator" style="background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);">
          <svg viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="15" y1="9" x2="9" y2="15"></line>
            <line x1="9" y1="9" x2="15" y2="15"></line>
          </svg>
        </div>

        <h1>${title}</h1>
        <p class="subtitle">${message}</p>

        ${showSOS ? `
          <div style="background: rgba(94, 217, 166, 0.1); border: 2px solid #5ED9A6; border-radius: 12px; padding: 1.5rem; margin: 2rem 0; text-align: left;">
            <h3 style="color: #2C3E50; margin: 0 0 1rem 0; font-size: 1.1rem; font-weight: 600;">
              üÜò Brauchst du Hilfe?
            </h3>
            <p style="color: #6B6B6B; margin-bottom: 1rem; line-height: 1.6;">
              Falls du ausgesperrt bist oder der Magic Link nicht funktioniert, kontaktiere uns direkt:
            </p>
            <div style="display: flex; flex-direction: column; gap: 0.75rem;">
              <a href="mailto:thomas@kinn.at?subject=Magic%20Link%20funktioniert%20nicht&body=Hallo%2C%0A%0AMein%20Magic%20Link%20funktioniert%20nicht.%20Meine%20Email%3A%20"
                 style="display: inline-flex; align-items: center; gap: 0.5rem; color: #2C3E50; text-decoration: none; padding: 0.75rem 1rem; background: white; border-radius: 8px; border: 1px solid rgba(0,0,0,0.1); transition: all 0.2s; font-weight: 500;"
                 onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'"
                 onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                <span style="font-size: 1.2rem;">üìß</span>
                <span>Email: thomas@kinn.at</span>
              </a>
              <a href="https://wa.me/436601238172?text=Hallo%2C%20mein%20KINN%20Magic%20Link%20funktioniert%20nicht."
                 style="display: inline-flex; align-items: center; gap: 0.5rem; color: #2C3E50; text-decoration: none; padding: 0.75rem 1rem; background: white; border-radius: 8px; border: 1px solid rgba(0,0,0,0.1); transition: all 0.2s; font-weight: 500;"
                 target="_blank"
                 onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'"
                 onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                <span style="font-size: 1.2rem;">üí¨</span>
                <span>WhatsApp: 0660 123 8172</span>
              </a>
            </div>
            <p style="color: #6B6B6B; margin-top: 1rem; font-size: 0.9rem; line-height: 1.5;">
              <strong>Tipp:</strong> √ñffne den Browser Developer Console (F12) und schicke uns einen Screenshot der Log-Meldungen - das hilft uns beim Debuggen!
            </p>
          </div>
        ` : ''}

        <a href="/" class="cta-button">
          Zur Startseite
        </a>
      `;
    }
    // Dashboard: Load Events
    async function loadEvents() {
      try {
        const response = await fetch('/api/events/upcoming');

        if (!response.ok) {
          throw new Error('Failed to load events');
        }

        const data = await response.json();
        const events = data.events || [];

        const container = document.getElementById('eventsContainer');

        if (!container) return; // Not on dashboard tab

        if (events.length === 0) {
          container.innerHTML = '<p class="empty-state">Noch keine Events geplant.</p>';
          return;
        }

        // Show next 3 events
        const upcomingEvents = events.slice(0, 3);

        container.innerHTML = `
          <ul class="event-list">
            ${upcomingEvents.map(event => {
              // Format location based on event type
              let locationInfo = '';
              if (event.type === 'online') {
                locationInfo = 'üåê Online';
              } else if (event.type === 'in-person') {
                locationInfo = `üìç ${event.location || 'Innsbruck'}`;
              } else if (event.type === 'hybrid') {
                locationInfo = `üìç ${event.location || 'Innsbruck'} + Online`;
              }

              return `
                <li class="event-item">
                  <div class="event-title">${event.title || 'KINN KI Treff'}</div>
                  <div class="event-date">${formatEventDate(event.date, event.startTime)}</div>
                  ${locationInfo ? `<div class="event-location" style="font-size: 0.875rem; color: #6B6B6B; margin-top: 0.25rem;">${locationInfo}</div>` : ''}
                  ${event.maxCapacity ? `
                    <div class="event-capacity" style="font-size: 0.875rem; color: #5ED9A6; margin-top: 0.25rem;">
                      üë• Max. ${event.maxCapacity} Teilnehmer
                    </div>
                  ` : ''}
                  ${event.status === 'tentative' ? '<div class="event-tentative-notice">‚ö†Ô∏è Details stehen noch nicht fest</div>' : ''}
                  ${event.meetingLink ? `
                    <a href="${event.meetingLink}" target="_blank" class="event-register-btn" style="display: inline-block; margin-top: 0.5rem; padding: 0.375rem 1rem; background: #5ED9A6; color: #000; text-decoration: none; border-radius: 6px; font-size: 0.875rem; font-weight: 500; transition: opacity 0.2s;">
                      üìÖ Anmelden
                    </a>
                  ` : ''}
                </li>
              `;
            }).join('')}
          </ul>
        `;

      } catch (error) {
        console.error('[DASHBOARD] Error loading events:', error);
        const container = document.getElementById('eventsContainer');
        if (container) {
          container.innerHTML = '<p class="empty-state">Events konnten nicht geladen werden.</p>';
        }
      }
    }

    function formatEventDate(dateStr, timeStr) {
      try {
        const date = new Date(dateStr);
        const options = {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        };
        const formattedDate = date.toLocaleDateString('de-DE', options);
        return `${formattedDate} um ${timeStr} Uhr`;
      } catch (error) {
        return `${dateStr} um ${timeStr} Uhr`;
      }
    }

    // ==================== NEW RADAR CALENDAR WIDGET ====================
    // Only visible for admin@libralab.ai for now

    let userRadarCalendarData = null;
    let userRadarView = 'calendar';

    async function loadRadarEventsWidget() {
      // Check if user is admin - only show widget for admin@libralab.ai
      const isAdmin = userEmail === 'admin@libralab.ai';
      const widgetEl = document.getElementById('radar-calendar-widget');

      if (!widgetEl) return;

      if (!isAdmin) {
        widgetEl.style.display = 'none';
        return;
      }

      // Show widget for admin
      widgetEl.style.display = 'block';
      setUserRadarView('calendar');
    }

    function setUserRadarView(view) {
      userRadarView = view;

      const calendarBtn = document.getElementById('user-radar-view-calendar');
      const listBtn = document.getElementById('user-radar-view-list');
      const calendarView = document.getElementById('user-radar-calendar-view');
      const listView = document.getElementById('user-radar-list-view');

      if (!calendarBtn || !listBtn) return;

      if (view === 'calendar') {
        calendarBtn.style.background = '#5ED9A6';
        calendarBtn.style.color = 'white';
        listBtn.style.background = 'white';
        listBtn.style.color = '#1F2937';
        calendarView.style.display = 'block';
        listView.style.display = 'none';
        loadUserRadarCalendar(2026);
      } else {
        listBtn.style.background = '#5ED9A6';
        listBtn.style.color = 'white';
        calendarBtn.style.background = 'white';
        calendarBtn.style.color = '#1F2937';
        calendarView.style.display = 'none';
        listView.style.display = 'block';
        loadUserRadarListView();
      }
    }

    async function loadUserRadarCalendar(year) {
      const gridEl = document.getElementById('user-radar-calendar-grid');
      const monthLabelsEl = document.getElementById('user-radar-month-labels');
      const legendEl = document.getElementById('user-radar-calendar-legend');

      if (!gridEl) return;

      gridEl.innerHTML = '<div style="padding: 15px; color: #9CA3AF; font-size: 0.8rem;">Lade...</div>';

      try {
        const res = await fetch(`/api/radar/calendar?year=${year}`);
        if (!res.ok) throw new Error('Failed to load');

        userRadarCalendarData = await res.json();
        renderUserRadarCalendar(userRadarCalendarData);
      } catch (error) {
        console.error('Error loading radar calendar:', error);
        gridEl.innerHTML = '<div style="padding: 15px; color: #ef4444; font-size: 0.8rem;">Fehler</div>';
      }
    }

    function renderUserRadarCalendar(data) {
      const gridEl = document.getElementById('user-radar-calendar-grid');
      const monthLabelsEl = document.getElementById('user-radar-month-labels');
      const legendEl = document.getElementById('user-radar-calendar-legend');
      const detailEl = document.getElementById('user-radar-day-detail');

      if (!gridEl || !monthLabelsEl) return;

      const dayLookup = {};
      data.days.forEach(day => { dayLookup[day.date] = day.events; });

      // Month labels - show once per month, track weeks per month for proper spacing
      const monthNames = ['Jan', 'Feb', 'M√§r', 'Apr', 'Mai', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dez'];
      let lastShownMonth = -1;
      let monthHtml = '';

      data.weeks.forEach((week, idx) => {
        // Find first day actually in the target year
        const inYearDay = week.days.find(d => d.isInYear);
        if (!inYearDay) {
          monthHtml += `<span style="display: inline-block; width: 21px;"></span>`;
          return;
        }

        const weekMonth = new Date(inYearDay.date).getMonth();

        // Show label only when month changes (each month ~4 weeks)
        if (weekMonth !== lastShownMonth) {
          monthHtml += `<span style="display: inline-block; width: 21px; font-size: 9px;">${monthNames[weekMonth]}</span>`;
          lastShownMonth = weekMonth;
        } else {
          monthHtml += `<span style="display: inline-block; width: 21px;"></span>`;
        }
      });
      monthLabelsEl.innerHTML = monthHtml;

      // Grid - store events data directly on elements for click handling
      let gridHtml = '';
      data.weeks.forEach(week => {
        let weekHtml = '<div style="display: flex; flex-direction: column; gap: 3px;">';
        week.days.forEach(day => {
          const events = dayLookup[day.date] || [];
          const hasEvents = events.length > 0;
          let bg = day.isInYear ? '#E5E7EB' : '#F3F4F6';
          if (hasEvents) bg = events[0].sourceColor || '#5ED9A6';

          const tooltipData = hasEvents ? JSON.stringify({ date: day.date, events: events.map(e => ({ title: e.title, source: e.source, sourceColor: e.sourceColor, time: e.time, location: e.location, detailUrl: e.detailUrl })) }).replace(/"/g, '&quot;') : '';

          weekHtml += `<div style="width: 18px; height: 18px; border-radius: 3px; background: ${bg}; cursor: ${hasEvents ? 'pointer' : 'default'};" data-date="${day.date}" data-events="${tooltipData}" ${hasEvents ? `onclick="showUserRadarDayDetail(this)"` : ''} onmouseenter="showUserRadarTooltip(event, this)" onmouseleave="hideUserRadarTooltip()"></div>`;
        });
        weekHtml += '</div>';
        gridHtml += weekHtml;
      });
      gridEl.innerHTML = gridHtml;

      // Legend
      let legendHtml = '';
      Object.entries(data.bySource).forEach(([source, count]) => {
        if (count > 0) {
          const color = data.sourceColors[source] || '#9CA3AF';
          legendHtml += `<span style="display: flex; align-items: center; gap: 3px;"><span style="width: 8px; height: 8px; border-radius: 50%; background: ${color};"></span>${source} (${count})</span>`;
        }
      });
      legendEl.innerHTML = legendHtml || `<span style="color: #9CA3AF;">Keine Events</span>`;
      if (detailEl) detailEl.style.display = 'none';
    }

    async function loadUserRadarListView() {
      const contentEl = document.getElementById('user-radar-list-content');
      if (!contentEl) return;

      contentEl.innerHTML = '<div style="padding: 15px; color: #9CA3AF; text-align: center; font-size: 0.8rem;">Lade...</div>';

      try {
        const [res1, res2] = await Promise.all([
          fetch('/api/radar/calendar?year=' + new Date().getFullYear()),
          fetch('/api/radar/calendar?year=' + (new Date().getFullYear() + 1))
        ]);
        const data1 = await res1.json();
        const data2 = await res2.json();

        const allEvents = [];
        const today = new Date().toISOString().split('T')[0];

        [...(data1.days || []), ...(data2.days || [])].forEach(day => {
          if (day.date >= today) {
            day.events.forEach(event => allEvents.push({ ...event, date: day.date }));
          }
        });

        allEvents.sort((a, b) => a.date !== b.date ? a.date.localeCompare(b.date) : (a.time || '').localeCompare(b.time || ''));
        renderUserRadarListView(allEvents);
      } catch (error) {
        contentEl.innerHTML = '<div style="padding: 15px; color: #ef4444; text-align: center; font-size: 0.8rem;">Fehler</div>';
      }
    }

    function renderUserRadarListView(events) {
      const contentEl = document.getElementById('user-radar-list-content');
      if (events.length === 0) {
        contentEl.innerHTML = '<div style="padding: 30px; color: #9CA3AF; text-align: center; font-size: 0.8rem;">Keine kommenden Events</div>';
        return;
      }

      const dayNames = ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'];
      const monthNames = ['Jan', 'Feb', 'M√§r', 'Apr', 'Mai', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dez'];
      let currentMonth = '';
      let html = '';

      events.forEach((event, idx) => {
        const date = new Date(event.date);
        const monthKey = `${date.getFullYear()}-${date.getMonth()}`;

        if (monthKey !== currentMonth) {
          currentMonth = monthKey;
          html += `<div style="font-size: 0.7rem; font-weight: 600; color: #6B7280; text-transform: uppercase; letter-spacing: 0.05em; padding: 10px 0 5px; ${idx > 0 ? 'border-top: 1px solid #e5e7eb; margin-top: 6px;' : ''}">${monthNames[date.getMonth()]} ${date.getFullYear()}</div>`;
        }

        const dayLabel = `${dayNames[date.getDay()]}, ${date.getDate()}.`;
        const isToday = event.date === new Date().toISOString().split('T')[0];

        html += `<div style="display: flex; gap: 10px; padding: 8px 0; border-bottom: 1px solid #f3f4f6; ${isToday ? 'background: #f0fdf4; margin: 0 -6px; padding-left: 6px; padding-right: 6px; border-radius: 4px;' : ''}">
          <div style="width: 45px; flex-shrink: 0; text-align: right;">
            <div style="font-size: 0.75rem; font-weight: 500; color: ${isToday ? '#16a34a' : '#1F2937'};">${isToday ? 'Heute' : dayLabel}</div>
            <div style="font-size: 0.65rem; color: #9CA3AF;">${event.time || ''}</div>
          </div>
          <div style="width: 8px; height: 8px; border-radius: 50%; background: ${event.sourceColor}; margin-top: 4px; flex-shrink: 0;"></div>
          <div style="flex: 1; min-width: 0;">
            <div style="font-weight: 500; color: #1F2937; font-size: 0.8rem; line-height: 1.3;">${event.title}</div>
            <div style="font-size: 0.7rem; color: #6B7280; margin-top: 1px;">${event.location} <span style="color: #9CA3AF;">${event.source}</span></div>
          </div>
          ${event.detailUrl ? `<a href="${event.detailUrl}" target="_blank" style="color: #5ED9A6; text-decoration: none; font-size: 1rem; flex-shrink: 0;">‚Üí</a>` : ''}
        </div>`;
      });

      html += `<div style="padding: 10px 0; text-align: center; font-size: 0.7rem; color: #9CA3AF;">${events.length} kommende Events</div>`;
      contentEl.innerHTML = html;
    }

    // Tooltip
    let userRadarTooltip = null;

    function showUserRadarTooltip(event, cell) {
      const tooltipData = cell.getAttribute('data-tooltip');
      if (!tooltipData) return;

      const data = JSON.parse(tooltipData.replace(/&quot;/g, '"'));
      const date = new Date(data.date);
      const dayNames = ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'];
      const monthNames = ['Jan', 'Feb', 'M√§r', 'Apr', 'Mai', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dez'];

      if (!userRadarTooltip) {
        userRadarTooltip = document.createElement('div');
        userRadarTooltip.style.cssText = 'position: fixed; background: white; border: 1px solid #e5e7eb; border-radius: 6px; padding: 6px 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); font-size: 11px; z-index: 1000; pointer-events: none; max-width: 180px;';
        document.body.appendChild(userRadarTooltip);
      }

      const dots = data.events.map(e => `<span style="display: inline-block; width: 6px; height: 6px; border-radius: 50%; background: ${e.sourceColor};"></span>`).join(' ');
      userRadarTooltip.innerHTML = `<div style="font-weight: 500; margin-bottom: 3px;">${dayNames[date.getDay()]}, ${date.getDate()}. ${monthNames[date.getMonth()]}</div><div style="display: flex; gap: 3px; margin-bottom: 2px;">${dots}</div><div style="color: #6B7280;">${data.events.length} Event${data.events.length > 1 ? 's' : ''}</div>`;

      const rect = cell.getBoundingClientRect();
      userRadarTooltip.style.left = `${rect.left + rect.width / 2 - 50}px`;
      userRadarTooltip.style.top = `${rect.top - 60}px`;
      userRadarTooltip.style.display = 'block';
    }

    function hideUserRadarTooltip() {
      if (userRadarTooltip) userRadarTooltip.style.display = 'none';
    }

    function showUserRadarDayDetail(element) {
      const eventsData = element.getAttribute('data-events');
      if (!eventsData) return;

      let data;
      try {
        data = JSON.parse(eventsData.replace(/&quot;/g, '"'));
      } catch(e) {
        console.error('Failed to parse events data:', e);
        return;
      }

      const detailEl = document.getElementById('user-radar-day-detail');
      const date = new Date(data.date);
      const dayNames = ['Sonntag', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag'];
      const monthNames = ['Januar', 'Februar', 'M√§rz', 'April', 'Mai', 'Juni', 'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];

      let eventsHtml = data.events.map(e => `<div style="display: flex; align-items: flex-start; gap: 8px; padding: 6px 0; border-bottom: 1px solid #e5e7eb;">
        <span style="width: 8px; height: 8px; border-radius: 50%; background: ${e.sourceColor}; margin-top: 4px; flex-shrink: 0;"></span>
        <div style="flex: 1;"><div style="font-weight: 500; color: #1F2937; font-size: 0.8rem;">${e.title}</div><div style="font-size: 0.75rem; color: #6B7280;">${e.time} ¬∑ ${e.location} <span style="color: #9CA3AF;">${e.source}</span></div></div>
        ${e.detailUrl ? `<a href="${e.detailUrl}" target="_blank" style="color: #5ED9A6; text-decoration: none;">‚Üí</a>` : ''}
      </div>`).join('');

      detailEl.innerHTML = `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;"><h4 style="margin: 0; font-size: 0.8rem; font-weight: 600;">${dayNames[date.getDay()]}, ${date.getDate()}. ${monthNames[date.getMonth()]}</h4><button onclick="document.getElementById('user-radar-day-detail').style.display='none'" style="background: none; border: none; cursor: pointer; color: #9CA3AF; font-size: 1rem;">&times;</button></div>${eventsHtml}`;
      detailEl.style.display = 'block';
    }

    // Expose functions to global scope (required for inline event handlers in ES modules)
    window.showUserRadarTooltip = showUserRadarTooltip;
    window.hideUserRadarTooltip = hideUserRadarTooltip;
    window.showUserRadarDayDetail = showUserRadarDayDetail;
    window.setUserRadarView = setUserRadarView;

    // OLD RADAR WIDGET CODE - DISABLED
    function displayRadarEvents(events, container, append = false) {
      // Disabled - old widget removed
      return;
    }
    function handleRadarScroll() { return; }
    function loadMoreRadarEvents() { return; }

    // PLACEHOLDER for old code compatibility
    let radarPage = 1;
    let radarLoading = false;
    let radarHasMore = false;

    function displayRadarEventsOLD(events, container, append = false) {
      const fragment = document.createDocumentFragment();

      events.forEach(event => {
        const eventEl = document.createElement('div');
        eventEl.className = 'radar-event-card';
        eventEl.style.cssText = `
          background: rgba(255, 255, 255, 0.9);
          border: 1px solid rgba(94, 217, 166, 0.2);
          border-radius: 0.75rem;
          padding: 1rem;
          margin-bottom: 0.75rem;
          transition: all 0.2s ease;
          cursor: pointer;
        `;

        // Format temporal proximity
        const proximity = formatTemporalProximity(event.date, event.time);

        // Determine category color
        const categoryColor = event.category?.toLowerCase().includes('ai') ? '#5ED9A6' :
                              event.category?.toLowerCase().includes('startup') ? '#4A90E2' :
                              event.category?.toLowerCase().includes('network') ? '#E0EEE9' : '#6B6B6B';

        eventEl.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
            <time style="color: #2C3E50; font-weight: 600; font-size: 0.875rem;">${proximity}</time>
            ${event.category ? `<span style="background: ${categoryColor}20; color: ${categoryColor}; padding: 0.125rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">${event.category}</span>` : ''}
          </div>
          <h3 style="font-size: 1rem; font-weight: 500; color: #3A3A3A; margin: 0.25rem 0;">${event.title || 'Untitled Event'}</h3>
          <p style="font-size: 0.875rem; color: #6B6B6B; margin: 0.25rem 0;">
            ${event.location || 'Location TBD'} ${event.time ? `¬∑ ${event.time} Uhr` : ''}
          </p>
          ${event.detailUrl ? `<a href="${event.detailUrl}" target="_blank" rel="noopener" style="color: #5ED9A6; text-decoration: none; font-size: 0.875rem; font-weight: 500;">Details ‚Üí</a>` : ''}
        `;

        // Add hover effect
        eventEl.addEventListener('mouseenter', () => {
          eventEl.style.transform = 'translateY(-2px)';
          eventEl.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
        });

        eventEl.addEventListener('mouseleave', () => {
          eventEl.style.transform = 'translateY(0)';
          eventEl.style.boxShadow = 'none';
        });

        // Click to open detail URL
        if (event.detailUrl) {
          eventEl.addEventListener('click', (e) => {
            if (e.target.tagName !== 'A') {
              window.open(event.detailUrl, '_blank');
            }
          });
        }

        fragment.appendChild(eventEl);
      });

      if (append) {
        container.appendChild(fragment);
      } else {
        container.appendChild(fragment);
      }
    }

    function formatTemporalProximity(dateStr, timeStr) {
      try {
        const eventDate = new Date(`${dateStr}T${timeStr || '18:00'}`);
        const now = new Date();
        const diffMs = eventDate - now;
        const hours = Math.floor(diffMs / (1000 * 60 * 60));
        const days = Math.floor(hours / 24);

        if (hours < 0) return 'Vergangen';
        if (hours < 1) return 'Jetzt';
        if (hours < 24) return `In ${hours} ${hours === 1 ? 'Stunde' : 'Stunden'}`;
        if (days === 1) return 'Morgen';
        if (days < 7) return `In ${days} Tagen`;
        if (days < 14) return 'N√§chste Woche';
        if (days < 30) return `In ${Math.floor(days / 7)} Wochen`;

        // For dates further out, show month and day
        const options = { day: 'numeric', month: 'short' };
        return eventDate.toLocaleDateString('de-AT', options);
      } catch (error) {
        return dateStr;
      }
    }

    /**
     * Smart Calendar Subscription with Visual Feedback
     * Priority-based device detection:
     * - Chrome (any OS) ‚Üí Google Calendar add URL
     * - Safari (iOS/Mac) ‚Üí webcal:// protocol
     * - Other ‚Üí .ics download with instructions
     */
    window.subscribeToCalendar = function(event) {
      const button = event?.target || event?.currentTarget || document.activeElement;
      const originalText = button ? button.textContent : 'Kalender abonnieren';
      const icsUrl = 'https://kinn.at/api/calendar.ics';
      const userAgent = navigator.userAgent.toLowerCase();

      const isAndroid = /android/.test(userAgent);
      const isIOS = /iphone|ipad|ipod/.test(userAgent);
      const isMac = /macintosh|mac os x/.test(userAgent);
      const isChrome = /chrome|chromium|crios/.test(userAgent) && !/edg/.test(userAgent);
      const isSafari = /safari/.test(userAgent) && !isChrome;
      const isWindows = /windows|win32|win64/.test(userAgent);

      console.log('[CALENDAR] Device detected:', {
        isAndroid,
        isIOS,
        isMac,
        isChrome,
        isSafari,
        isWindows,
        userAgent: userAgent.substring(0, 100)
      });

      // Priority 1: Chrome/Chromium on ANY platform ‚Üí Google Calendar
      if (isChrome) {
        if (button) {
          button.textContent = '√ñffne Google Calendar...';
          button.disabled = true;
        }

        // Google Calendar requires webcal:// protocol for subscription
        const webcalUrl = icsUrl.replace('https://', 'webcal://');
        const googleCalUrl = `https://calendar.google.com/calendar/render?cid=${encodeURIComponent(webcalUrl)}`;
        console.log('[CALENDAR] Opening Google Calendar add URL with webcal://');

        const newWindow = window.open(googleCalUrl, '_blank');

        // Reset button after 2 seconds
        setTimeout(() => {
          if (button) {
            button.textContent = originalText;
            button.disabled = false;

            // If popup was blocked, show message
            if (!newWindow || newWindow.closed || typeof newWindow.closed === 'undefined') {
              alert('Popup wurde blockiert! Bitte erlaube Popups f√ºr diese Seite und versuche es erneut.');
            }
          }
        }, 2000);
        return;
      }

      // Priority 2: Safari on iOS/macOS ‚Üí webcal:// protocol
      if (isSafari && (isIOS || isMac)) {
        if (button) {
          button.textContent = '√ñffne Kalender App...';
          button.disabled = true;
        }

        console.log('[CALENDAR] Opening webcal:// protocol for Safari');

        // Try webcal:// - Safari handles this well
        window.location.href = 'webcal://kinn.at/api/calendar.ics';

        // Reset button after 3 seconds
        setTimeout(() => {
          if (button) {
            button.textContent = originalText;
            button.disabled = false;
          }
        }, 3000);
        return;
      }

      // Priority 3: Everything else ‚Üí Download .ics with instructions
      if (button) {
        button.textContent = 'Download startet...';
        button.disabled = true;
      }

      console.log('[CALENDAR] Downloading .ics file');

      // Create and trigger download
      const link = document.createElement('a');
      link.href = icsUrl;
      link.download = 'kinn-events.ics';
      link.target = '_blank';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      // Show helpful message
      setTimeout(() => {
        if (button) {
          button.textContent = '‚úì Datei heruntergeladen';

          // Reset button after 3 seconds
          setTimeout(() => {
            button.textContent = originalText;
            button.disabled = false;
          }, 3000);
        }
      }, 500);
    }
  </script>
  <!-- Luma Checkout Popup -->
  <script id="luma-checkout" src="https://embed.lu.ma/checkout-button.js"></script>
</body>
</html>
