<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - KINN Event Creator</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #ffffff;
      color: #000;
      padding: 40px 20px;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
    }

    .logo-link {
      display: block;
      width: 200px;
      margin: 0 auto 2rem;
      cursor: pointer;
      transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .logo-link:hover {
      transform: scale(1.02);
    }

    .logo {
      width: 100%;
      height: auto;
      display: block;
    }

    h1 {
      font-size: 2rem;
      font-weight: 300;
      color: #333;
      text-align: center;
      margin-bottom: 1rem;
    }

    .subtitle {
      text-align: center;
      color: #999;
      margin-bottom: 2rem;
      font-size: 0.9rem;
    }

    /* Tab Navigation */
    .tab-nav {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin-bottom: 2rem;
      border-bottom: 2px solid #e0e0e0;
    }

    .tab-btn {
      padding: 0.75rem 1.5rem;
      background: none;
      border: none;
      border-bottom: 3px solid transparent;
      cursor: pointer;
      font-size: 0.95rem;
      font-weight: 500;
      color: #666;
      transition: all 0.2s ease;
      margin-bottom: -2px;
    }

    .tab-btn:hover {
      color: #333;
    }

    .tab-btn.active {
      color: #000;
      border-bottom-color: #5ED9A6;
      font-weight: 600;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .form-section {
      background: #f9f9f9;
      border-radius: 12px;
      padding: 2rem;
      margin-bottom: 2rem;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    label {
      display: block;
      font-weight: 500;
      margin-bottom: 0.5rem;
      color: #333;
    }

    input, textarea, select {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
      font-family: inherit;
    }

    textarea {
      min-height: 100px;
      resize: vertical;
    }

    select {
      cursor: pointer;
      background-color: #fff;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23333' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 36px;
      appearance: none;
    }

    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: #E0EEE9;
      box-shadow: 0 0 0 3px rgba(224, 238, 233, 0.3);
    }

    .datetime-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    .button {
      background: #E0EEE9;
      color: #000;
      padding: 14px 32px;
      border: none;
      border-radius: 12px;
      font-size: 1.125rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      width: 100%;
      margin-top: 1rem;
    }

    .button:hover {
      background: #d0ddd4;
      transform: translateY(-1px);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
    }

    .button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .result {
      display: none;
      background: #f0f0f0;
      border-radius: 12px;
      padding: 1.5rem;
      margin-top: 2rem;
    }

    .result.show {
      display: block;
    }

    .result.success {
      background: #d4edda;
      border-left: 4px solid #28a745;
    }

    .result.error {
      background: #f8d7da;
      border-left: 4px solid #dc3545;
    }

    .result h3 {
      margin-bottom: 1rem;
      font-size: 1.2rem;
    }

    .result-details {
      font-family: 'Monaco', 'Courier New', monospace;
      font-size: 0.85rem;
      background: rgba(0, 0, 0, 0.05);
      padding: 1rem;
      border-radius: 8px;
      overflow-x: auto;
      max-height: 400px;
      overflow-y: auto;
    }

    .api-key-input {
      font-family: 'Monaco', 'Courier New', monospace;
      font-size: 0.9rem;
    }

    .example {
      background: #fff;
      border-left: 4px solid #E0EEE9;
      padding: 1rem;
      margin: 1rem 0;
      font-size: 0.9rem;
      color: #666;
    }

    @media (max-width: 640px) {
      .datetime-group {
        grid-template-columns: 1fr;
      }
    }
    /* Dashboard Metrics */
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .metric-card {
      background: #f9f9f9;
      border-radius: 12px;
      padding: 1.5rem;
      border-left: 4px solid #5ED9A6;
    }

    .metric-card h3 {
      font-size: 0.875rem;
      font-weight: 600;
      color: #666;
      margin-bottom: 0.5rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .metric-value {
      font-size: 2.5rem;
      font-weight: 300;
      color: #000;
      margin-bottom: 0.5rem;
    }

    .metric-label {
      font-size: 0.875rem;
      color: #999;
    }

    .metric-subvalue {
      font-size: 1rem;
      color: #666;
      margin-top: 0.5rem;
    }

    .skill-list {
      list-style: none;
      padding: 0;
    }

    .skill-item {
      display: flex;
      justify-content: space-between;
      padding: 0.5rem 0;
      border-bottom: 1px solid #e0e0e0;
    }

    .skill-item:last-child {
      border-bottom: none;
    }

    .skill-name {
      font-weight: 500;
      color: #333;
    }

    .skill-count {
      color: #5ED9A6;
      font-weight: 600;
    }

    .loading {
      text-align: center;
      padding: 3rem;
      color: #999;
    }

    .error-state {
      background: #fff3f3;
      border: 1px solid #ff6b6b;
      border-radius: 8px;
      padding: 1.5rem;
      color: #d63031;
    }
  </style>

  <!-- Vercel Web Analytics -->
  <script defer src="/_vercel/insights/script.js"></script>
</head>
<body>
  <div class="container">
    <!-- KINN Logo -->
    <a href="/" class="logo-link">
      <svg class="logo" viewBox="0 0 640 160" xmlns="http://www.w3.org/2000/svg">
        <rect width="640" height="160" fill="none"/>
        <text x="320" y="120" font-family="system-ui, -apple-system, sans-serif" font-size="120" font-weight="300" text-anchor="middle" fill="#000">KINN</text>
      </svg>
    </a>

    <h1>KINN Admin</h1>
    <p class="subtitle">Event Management, Dashboard & User Tools</p>

    <!-- Tab Navigation -->
    <div class="tab-nav">
      <button class="tab-btn" data-tab="dashboard" onclick="switchTab('dashboard')">Dashboard</button>
      <button class="tab-btn active" data-tab="events" onclick="switchTab('events')">Events</button>
      <button class="tab-btn" data-tab="users" onclick="switchTab('users')">Users</button>
    </div>

    <!-- Tab: Dashboard -->
    <div class="tab-content" data-tab="dashboard">
      <div id="dashboardContainer" class="loading">
        Loading metrics...
      </div>
    </div>

    <!-- Tab: Events (Event Creator Form) -->
    <div class="tab-content active" data-tab="events">
      <!-- Event Form -->
    <form id="eventForm" class="form-section">
      <!-- API Key Section (inside form to fix DOM warning) -->
      <div class="form-group">
        <label for="apiKey">Admin API Key *</label>
        <input
          type="password"
          id="apiKey"
          class="api-key-input"
          placeholder="Gib deinen Admin API Key ein..."
          required
        >
      </div>

      <hr style="margin: 2rem 0; border: none; border-top: 1px solid #e0e0e0;">

      <!-- Event Details -->
      <div class="form-group">
        <label for="summary">Event Titel *</label>
        <input
          type="text"
          id="summary"
          placeholder="z.B. KINN KI Treff #12: Prompt Engineering Workshop"
          required
        >
      </div>

      <div class="form-group">
        <label for="description">Beschreibung</label>
        <textarea
          id="description"
          placeholder="Details zum Event..."
        ></textarea>
      </div>

      <div class="form-group">
        <label for="eventType">Event Type *</label>
        <select id="eventType" required>
          <option value="in-person">Pr√§senz (In-Person)</option>
          <option value="online">Online (Google Meet/Zoom)</option>
          <option value="hybrid">Hybrid (Pr√§senz + Online)</option>
        </select>
      </div>

      <div class="form-group" id="locationGroup">
        <label for="location">Location</label>
        <input
          type="text"
          id="location"
          placeholder="z.B. KINN Office, Maria-Theresien-Stra√üe 18, Innsbruck"
          value="Innsbruck, Tirol"
        >
      </div>

      <div class="form-group" id="meetingLinkGroup" style="display: none;">
        <label for="meetingLink">Meeting Link</label>
        <input
          type="url"
          id="meetingLink"
          placeholder="https://meet.google.com/xyz-abc-def"
        >
        <div class="example">F√ºr Online/Hybrid Events: Google Meet, Zoom, etc.</div>
      </div>

      <div class="form-group" id="maxCapacityGroup">
        <label for="maxCapacity">Max. Teilnehmer (optional)</label>
        <input
          type="number"
          id="maxCapacity"
          placeholder="z.B. 20"
          min="1"
        >
        <div class="example">Leer lassen f√ºr unbegrenzte Teilnehmerzahl</div>
      </div>

      <div class="datetime-group">
        <div class="form-group">
          <label for="start">Start *</label>
          <input
            type="datetime-local"
            id="start"
            required
          >
          <div class="example">Format: 2025-02-15 18:00</div>
        </div>

        <div class="form-group">
          <label for="end">Ende *</label>
          <input
            type="datetime-local"
            id="end"
            required
          >
          <div class="example">Format: 2025-02-15 20:00</div>
        </div>
      </div>

      <button type="submit" class="button" id="submitBtn">
        üìÖ Event f√ºr alle Kalender erstellen
      </button>
    </form>

    <!-- Result Display -->
    <div id="result" class="result">
      <h3 id="resultTitle"></h3>
      <pre id="resultDetails" class="result-details"></pre>
    </div>
    </div>
    <!-- End Tab: Events -->

    <!-- Tab: Users -->
    <div class="tab-content" data-tab="users">
      <div id="usersContainer" class="loading">
        Coming soon...
      </div>
    </div>
    <!-- End Tab: Users -->

  </div>

  <script>
    // Tab Switching
    function switchTab(tabName) {
      // Update button states
      document.querySelectorAll('.tab-btn').forEach(btn => {
        if (btn.dataset.tab === tabName) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      });

      // Update tab content
      document.querySelectorAll('.tab-content').forEach(content => {
        if (content.dataset.tab === tabName) {
          content.classList.add('active');
        } else {
          content.classList.remove('active');
        }
      });

      // Load dashboard data when switching to dashboard tab
      if (tabName === 'dashboard') {
        loadDashboard();
      }
    }

    // Load Dashboard Metrics
    async function loadDashboard() {
      const container = document.getElementById('dashboardContainer');
      const apiKey = localStorage.getItem('kinn_admin_api_key');

      if (!apiKey) {
        container.innerHTML = '<div class="error-state">Please enter your Admin API Key in the Events tab first.</div>';
        return;
      }

      container.innerHTML = '<div class="loading">Loading dashboard metrics...</div>';

      try {
        const response = await fetch('/api/admin/dashboard', {
          headers: {
            'Authorization': `Bearer ${apiKey}`
          }
        });

        if (!response.ok) {
          throw new Error('Failed to load dashboard');
        }

        const data = await response.json();
        renderDashboard(data.metrics);

      } catch (error) {
        console.error('[DASHBOARD] Error:', error);
        container.innerHTML = `<div class="error-state">Failed to load dashboard: ${error.message}</div>`;
      }
    }

    // Render Dashboard UI
    function renderDashboard(metrics) {
      const container = document.getElementById('dashboardContainer');

      container.innerHTML = `
        <!-- Subscriber Metrics -->
        <div class="metrics-grid">
          <div class="metric-card">
            <h3>Total Subscribers</h3>
            <div class="metric-value">${metrics.subscribers.total}</div>
            <div class="metric-subvalue">
              ‚úÖ ${metrics.subscribers.complete} complete (${metrics.subscribers.completionRate}%)
              <br>
              ‚ö†Ô∏è ${metrics.subscribers.incomplete} incomplete
            </div>
          </div>

          <div class="metric-card">
            <h3>Upcoming Events</h3>
            <div class="metric-value">${metrics.events.upcoming}</div>
            <div class="metric-label">
              ${metrics.events.nextEvent ? `Next: ${metrics.events.nextEvent.title}` : 'No events scheduled'}
            </div>
          </div>

          <div class="metric-card">
            <h3>Last Event RSVP</h3>
            <div class="metric-value">${metrics.events.lastEvent ? metrics.events.lastEvent.rsvps.total : '‚Äî'}</div>
            <div class="metric-label">
              ${metrics.events.lastEvent
                ? `${metrics.events.lastEvent.rsvps.yes} Yes ¬∑ ${metrics.events.lastEvent.rsvps.maybe} Maybe ¬∑ ${metrics.events.lastEvent.rsvps.no} No`
                : 'No past events'}
            </div>
          </div>
        </div>

        <!-- Top Skills -->
        <div class="form-section">
          <h2 style="margin-bottom: 1rem;">üî• Top Skills (${metrics.skills.total} total)</h2>
          <ul class="skill-list">
            ${metrics.skills.top.slice(0, 10).map(skill => `
              <li class="skill-item">
                <span class="skill-name">${skill.skill}</span>
                <span class="skill-count">${skill.count}</span>
              </li>
            `).join('')}
          </ul>
        </div>

        <!-- Distribution Stats -->
        <div class="metrics-grid">
          <div class="metric-card">
            <h3>Location Split</h3>
            <div class="metric-subvalue">
              üìç Tirol: ${metrics.location.tirol} (${Math.round(metrics.location.tirol / metrics.subscribers.total * 100)}%)<br>
              üåê Online: ${metrics.location.online} (${Math.round(metrics.location.online / metrics.subscribers.total * 100)}%)<br>
              üîÄ All: ${metrics.location.all} (${Math.round(metrics.location.all / metrics.subscribers.total * 100)}%)
            </div>
          </div>

          <div class="metric-card">
            <h3>Work Status</h3>
            <div class="metric-subvalue">
              üíº Employed: ${metrics.work.employed}<br>
              üöÄ Freelancer: ${metrics.work.freelancer}<br>
              üéì Student: ${metrics.work.student}<br>
              üîç Between Jobs: ${metrics.work.betweenJobs}
            </div>
          </div>

          <div class="metric-card">
            <h3>Experience Level</h3>
            <div class="metric-subvalue">
              üå± Junior: ${metrics.level.junior}<br>
              üìà Mid: ${metrics.level.mid}<br>
              üéØ Senior: ${metrics.level.senior}<br>
              ‚≠ê Lead: ${metrics.level.lead}
            </div>
          </div>
        </div>

        <!-- Invite Section -->
        <div class="form-section" style="border-left: 4px solid #5ED9A6;">
          <h2 style="margin-bottom: 0.5rem;">üì® User einladen</h2>
          <p style="color: #666; margin-bottom: 1.5rem;">
            Lade jemanden ein, den du bei einem Event getroffen hast.
          </p>

          <div class="form-group">
            <label for="inviteName">Vorname *</label>
            <input type="text" id="inviteName" placeholder="z.B. Sarah">
          </div>

          <div class="form-group">
            <label for="inviteEmail">Email *</label>
            <input type="email" id="inviteEmail" placeholder="email@example.com">
          </div>

          <div class="form-group">
            <label for="invitedBy">Eingeladen von (optional)</label>
            <input type="text" id="invitedBy" placeholder="Thomas" value="Thomas">
          </div>

          <button class="button" onclick="sendInvite()" style="margin-top: 0;">
            Einladung senden
          </button>

          <div id="inviteResult" style="margin-top: 1rem;"></div>
        </div>

        <!-- Incomplete Profiles Alert -->
        ${metrics.subscribers.incomplete > 0 ? `
          <div class="form-section" style="border-left: 4px solid #ff6b6b;">
            <h3 style="color: #ff6b6b; margin-bottom: 1rem;">‚ö†Ô∏è ${metrics.subscribers.incomplete} Incomplete Profiles</h3>
            <p style="color: #666; margin-bottom: 1rem;">
              These users signed up but haven't completed their profile yet.
            </p>
            <button class="button" style="background: #ff6b6b; color: white;" onclick="alert('Reminder feature coming soon!')">
              Send Reminder Email to All
            </button>
          </div>
        ` : ''}
      `;
    }

    // Send Invite
    async function sendInvite() {
      const nameInput = document.getElementById('inviteName');
      const emailInput = document.getElementById('inviteEmail');
      const invitedByInput = document.getElementById('invitedBy');
      const resultDiv = document.getElementById('inviteResult');
      const apiKey = localStorage.getItem('kinn_admin_api_key');

      if (!apiKey) {
        resultDiv.innerHTML = '<div style="background: #fff3f3; border: 1px solid #ff6b6b; border-radius: 8px; padding: 1rem; color: #d63031;">‚ùå Please enter your Admin API Key in the Events tab first.</div>';
        return;
      }

      const name = nameInput.value.trim();
      const email = emailInput.value.trim();
      const invitedBy = invitedByInput.value.trim() || 'Thomas';

      if (!name || !email) {
        resultDiv.innerHTML = '<div style="background: #fff3f3; border: 1px solid #ff6b6b; border-radius: 8px; padding: 1rem; color: #d63031;">‚ùå Bitte Name und Email eingeben</div>';
        return;
      }

      // Show loading state
      resultDiv.innerHTML = '<div style="background: #f0f0f0; border-radius: 8px; padding: 1rem; color: #666;">‚è≥ Einladung wird versendet...</div>';

      try {
        const response = await fetch('/api/admin/invite', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${apiKey}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ name, email, invitedBy })
        });

        const data = await response.json();

        if (response.ok) {
          resultDiv.innerHTML = `<div style="background: #d4edda; border-left: 4px solid #28a745; border-radius: 8px; padding: 1rem; color: #155724;">‚úÖ ${data.message}</div>`;
          // Clear form
          nameInput.value = '';
          emailInput.value = '';
          invitedByInput.value = 'Thomas';
        } else {
          resultDiv.innerHTML = `<div style="background: #fff3f3; border: 1px solid #ff6b6b; border-radius: 8px; padding: 1rem; color: #d63031;">‚ùå ${data.message || data.error}</div>`;
        }
      } catch (error) {
        console.error('[INVITE] Error:', error);
        resultDiv.innerHTML = `<div style="background: #fff3f3; border: 1px solid #ff6b6b; border-radius: 8px; padding: 1rem; color: #d63031;">‚ùå Fehler: ${error.message}</div>`;
      }
    }

    const form = document.getElementById('eventForm');
    const submitBtn = document.getElementById('submitBtn');
    const resultDiv = document.getElementById('result');
    const resultTitle = document.getElementById('resultTitle');
    const resultDetails = document.getElementById('resultDetails');
    const apiKeyInput = document.getElementById('apiKey');

    // Load API key from localStorage on page load
    const savedApiKey = localStorage.getItem('kinn_admin_api_key');
    if (savedApiKey) {
      apiKeyInput.value = savedApiKey;
    }

    // Conditional form fields based on event type
    const eventTypeSelect = document.getElementById('eventType');
    const locationGroup = document.getElementById('locationGroup');
    const meetingLinkGroup = document.getElementById('meetingLinkGroup');
    const maxCapacityGroup = document.getElementById('maxCapacityGroup');

    eventTypeSelect.addEventListener('change', () => {
      const type = eventTypeSelect.value;

      // Show/hide fields based on event type
      if (type === 'online') {
        locationGroup.style.display = 'none';
        meetingLinkGroup.style.display = 'block';
        maxCapacityGroup.style.display = 'none';
      } else if (type === 'hybrid') {
        locationGroup.style.display = 'block';
        meetingLinkGroup.style.display = 'block';
        maxCapacityGroup.style.display = 'block';
      } else { // in-person
        locationGroup.style.display = 'block';
        meetingLinkGroup.style.display = 'none';
        maxCapacityGroup.style.display = 'block';
      }
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      // Get values
      const apiKey = apiKeyInput.value.trim();
      const eventType = document.getElementById('eventType').value;
      const summary = document.getElementById('summary').value.trim();
      const description = document.getElementById('description').value.trim();
      const location = document.getElementById('location').value.trim();
      const meetingLink = document.getElementById('meetingLink').value.trim();
      const maxCapacity = document.getElementById('maxCapacity').value;
      const start = document.getElementById('start').value;
      const end = document.getElementById('end').value;

      // Validate API key
      if (!apiKey) {
        alert('Bitte gib den Admin API Key ein.');
        return;
      }

      // Disable button
      submitBtn.disabled = true;
      submitBtn.textContent = 'Events werden erstellt...';

      // Convert datetime-local to ISO 8601
      const startISO = new Date(start).toISOString();
      const endISO = new Date(end).toISOString();

      try {
        const response = await fetch('/api/events/create', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`,
          },
          body: JSON.stringify({
            type: eventType,
            summary,
            description,
            location,
            meetingLink: meetingLink || undefined,
            maxCapacity: maxCapacity ? parseInt(maxCapacity) : undefined,
            start: startISO,
            end: endISO,
          }),
        });

        // Check if response is JSON
        const contentType = response.headers.get('content-type');
        let data;

        if (contentType && contentType.includes('application/json')) {
          data = await response.json();
        } else {
          // Response is not JSON (probably HTML error page)
          const text = await response.text();
          throw new Error(`Server returned non-JSON response: ${text.substring(0, 200)}`);
        }

        // Display result
        resultDiv.classList.remove('success', 'error');
        resultDiv.classList.add('show');

        if (response.ok) {
          // Save API key to localStorage on success
          localStorage.setItem('kinn_admin_api_key', apiKey);

          resultDiv.classList.add('success');
          resultTitle.textContent = `‚úÖ Erfolg: ${data.stats.successful} Events erstellt`;
          resultDetails.textContent = JSON.stringify(data, null, 2);
        } else {
          resultDiv.classList.add('error');
          resultTitle.textContent = '‚ùå Fehler: Event-Erstellung fehlgeschlagen';
          resultDetails.textContent = JSON.stringify(data, null, 2);
        }

      } catch (error) {
        resultDiv.classList.remove('success');
        resultDiv.classList.add('error', 'show');
        resultTitle.textContent = '‚ùå Fehler: Netzwerk-Problem';
        resultDetails.textContent = error.message;
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'üìÖ Event f√ºr alle Kalender erstellen';
      }
    });

    // Set default times (tomorrow 18:00 - 20:00)
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    tomorrow.setHours(18, 0, 0, 0);

    const endTime = new Date(tomorrow);
    endTime.setHours(20, 0, 0, 0);

    // Format for datetime-local input (YYYY-MM-DDTHH:mm)
    const formatDatetimeLocal = (date) => {
      const pad = (n) => n.toString().padStart(2, '0');
      return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())}T${pad(date.getHours())}:${pad(date.getMinutes())}`;
    };

    document.getElementById('start').value = formatDatetimeLocal(tomorrow);
    document.getElementById('end').value = formatDatetimeLocal(endTime);
  </script>
</body>
</html>
