<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KINN-RADAR Source Audit Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', monospace;
            background: #1a1a2e;
            color: #eee;
            padding: 20px;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        .subtitle {
            opacity: 0.9;
            font-size: 1.1em;
        }
        .controls {
            background: #2d2d44;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        .btn {
            background: #5ED9A6;
            color: #1a1a2e;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            transition: all 0.3s;
        }
        .btn:hover {
            background: #4BC997;
            transform: translateY(-2px);
        }
        .btn-secondary {
            background: #764ba2;
            color: white;
        }
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        .source-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .source-card {
            background: #2d2d44;
            border-radius: 10px;
            padding: 20px;
            border: 2px solid #3d3d5c;
            transition: all 0.3s;
        }
        .source-card:hover {
            border-color: #5ED9A6;
            transform: translateY(-2px);
        }
        .source-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .source-name {
            font-size: 1.3em;
            font-weight: bold;
            color: #5ED9A6;
        }
        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: bold;
        }
        .status-working { background: #27ae60; color: white; }
        .status-failing { background: #e74c3c; color: white; }
        .status-partial { background: #f39c12; color: white; }
        .status-untested { background: #7f8c8d; color: white; }
        .metrics {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 15px 0;
        }
        .metric {
            background: #1a1a2e;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
        }
        .metric-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #5ED9A6;
        }
        .metric-label {
            font-size: 0.8em;
            opacity: 0.7;
            margin-top: 3px;
        }
        .audit-checklist {
            background: #1a1a2e;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
        }
        .checklist-item {
            padding: 8px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .checklist-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        .audit-notes {
            width: 100%;
            background: #1a1a2e;
            border: 1px solid #3d3d5c;
            color: #eee;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            min-height: 100px;
            font-family: inherit;
        }
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .action-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        .btn-test { background: #3498db; color: white; }
        .btn-fix { background: #9b59b6; color: white; }
        .btn-save { background: #2ecc71; color: white; }
        .summary-section {
            background: #2d2d44;
            padding: 25px;
            border-radius: 10px;
            margin-top: 30px;
        }
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .summary-stat {
            text-align: center;
        }
        .summary-value {
            font-size: 3em;
            font-weight: bold;
            color: #5ED9A6;
        }
        .summary-label {
            font-size: 0.9em;
            opacity: 0.8;
            margin-top: 5px;
        }
        .progress-bar {
            height: 30px;
            background: #1a1a2e;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #5ED9A6, #4BC997);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #1a1a2e;
            font-weight: bold;
        }
        .pattern-library {
            background: #1a1a2e;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
        }
        .pattern-code {
            background: #0d0d1a;
            padding: 10px;
            border-radius: 4px;
            font-family: 'SF Mono', monospace;
            font-size: 0.9em;
            color: #5ED9A6;
            margin: 5px 0;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üî¨ KINN-RADAR Source Audit Dashboard</h1>
        <div class="subtitle">First Principles Approach to Event Extraction</div>
    </div>

    <div class="controls">
        <button class="btn" onclick="auditAllSources()">üîç Audit All Sources</button>
        <button class="btn btn-secondary" onclick="testExtraction()">üß™ Test Extraction</button>
        <button class="btn btn-secondary" onclick="generateReport()">üìä Generate Report</button>
        <button class="btn btn-danger" onclick="exportPatterns()">üíæ Export Patterns</button>
    </div>

    <div class="summary-section">
        <h2>üìà Overall Health</h2>
        <div class="summary-grid">
            <div class="summary-stat">
                <div class="summary-value" id="totalSources">15</div>
                <div class="summary-label">Total Sources</div>
            </div>
            <div class="summary-stat">
                <div class="summary-value" id="workingSources">0</div>
                <div class="summary-label">Working</div>
            </div>
            <div class="summary-stat">
                <div class="summary-value" id="partialSources">0</div>
                <div class="summary-label">Partial</div>
            </div>
            <div class="summary-stat">
                <div class="summary-value" id="failingSources">0</div>
                <div class="summary-label">Failing</div>
            </div>
        </div>
        <div class="progress-bar">
            <div class="progress-fill" id="progressBar" style="width: 0%">0% Complete</div>
        </div>
    </div>

    <div class="source-grid" id="sourceGrid"></div>

    <script>
        // Source configurations with audit data
        const sources = [
            {
                name: 'InnCubator',
                url: 'https://www.inncubator.at/events',
                status: 'untested',
                events_found: 0,
                last_check: null,
                patterns: {
                    container: 'article.event-item',
                    date: 'span.event-weekday + span.event-day + span.event-year',
                    title: 'h2.event-title',
                    requires_js: true
                }
            },
            {
                name: 'Startup.Tirol',
                url: 'https://www.startup.tirol/events/',
                status: 'untested',
                events_found: 0,
                patterns: {
                    container: '.tribe-events-list',
                    date: '.tribe-event-date-start',
                    api: 'wp-json/tribe/events/v1/events'
                }
            },
            {
                name: 'WKO Tirol',
                url: 'https://www.wko.at/veranstaltungen/start?bundesland=T',
                status: 'untested',
                events_found: 0,
                patterns: {
                    container: 'li.col-md-6.col-lg-4 div.card.card-eventbox',
                    date: 'dd elements (day, month, year)',
                    special: 'MUST use ?bundesland=T parameter'
                }
            },
            {
                name: 'AI Austria',
                url: 'https://aiaustria.com/event-calendar',
                status: 'untested',
                events_found: 0,
                patterns: {}
            },
            {
                name: 'Standortagentur Tirol',
                url: 'https://www.standort-tirol.at/veranstaltungen',
                status: 'untested',
                events_found: 0,
                patterns: {}
            },
            {
                name: 'Impact Hub Tirol',
                url: 'https://tirol.impacthub.net/en/collection/?_sf_tag=upcoming-events',
                status: 'untested',
                events_found: 0,
                patterns: {
                    requires_js: true,
                    special: 'Dynamic filtering'
                }
            },
            {
                name: 'Uni Innsbruck',
                url: 'https://www.uibk.ac.at/events/',
                status: 'untested',
                events_found: 0,
                patterns: {}
            },
            {
                name: 'MCI',
                url: 'https://www.mci4me.at/de/events',
                status: 'untested',
                events_found: 0,
                patterns: {}
            },
            {
                name: 'FH Kufstein',
                url: 'https://www.fh-kufstein.ac.at/service/events',
                status: 'untested',
                events_found: 0,
                patterns: {}
            },
            {
                name: 'LSZ',
                url: 'https://lsz.at/',
                status: 'untested',
                events_found: 0,
                patterns: {}
            },
            {
                name: 'Das Wundervoll',
                url: 'https://www.daswundervoll.at/en/about-wundervoll/events',
                status: 'untested',
                events_found: 0,
                patterns: {}
            },
            {
                name: 'Die B√§ckerei',
                url: 'https://diebaeckerei.at/programm',
                status: 'untested',
                events_found: 0,
                patterns: {}
            },
            {
                name: 'DIH West',
                url: 'https://www.dih-west.at/events',
                status: 'untested',
                events_found: 0,
                patterns: {}
            },
            {
                name: 'Innsbruck.info',
                url: 'https://www.innsbruck.info/brauchtum-und-events/veranstaltungskalender.html',
                status: 'untested',
                events_found: 0,
                patterns: {}
            },
            {
                name: 'Congress Messe Innsbruck',
                url: 'https://www.cmi.at/de/veranstaltungskalender',
                status: 'untested',
                events_found: 0,
                patterns: {}
            }
        ];

        // Initialize dashboard
        function initDashboard() {
            const grid = document.getElementById('sourceGrid');
            grid.innerHTML = '';

            sources.forEach((source, index) => {
                const card = createSourceCard(source, index);
                grid.appendChild(card);
            });

            updateSummary();
        }

        function createSourceCard(source, index) {
            const card = document.createElement('div');
            card.className = 'source-card';
            card.innerHTML = `
                <div class="source-header">
                    <div class="source-name">${source.name}</div>
                    <span class="status-badge status-${source.status}">${source.status.toUpperCase()}</span>
                </div>

                <div class="metrics">
                    <div class="metric">
                        <div class="metric-value">${source.events_found}</div>
                        <div class="metric-label">Events</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value">${source.patterns.requires_js ? 'JS' : 'Static'}</div>
                        <div class="metric-label">Type</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value">${source.last_check ? '‚úì' : '‚Äî'}</div>
                        <div class="metric-label">Tested</div>
                    </div>
                </div>

                <div class="audit-checklist">
                    <div class="checklist-item">
                        <input type="checkbox" id="check-${index}-1" onchange="updateSource(${index})">
                        <label for="check-${index}-1">‚úì URL is accessible</label>
                    </div>
                    <div class="checklist-item">
                        <input type="checkbox" id="check-${index}-2" onchange="updateSource(${index})">
                        <label for="check-${index}-2">‚úì Events visible on page</label>
                    </div>
                    <div class="checklist-item">
                        <input type="checkbox" id="check-${index}-3" onchange="updateSource(${index})">
                        <label for="check-${index}-3">‚úì FREE events identified</label>
                    </div>
                    <div class="checklist-item">
                        <input type="checkbox" id="check-${index}-4" onchange="updateSource(${index})">
                        <label for="check-${index}-4">‚úì Date pattern found</label>
                    </div>
                    <div class="checklist-item">
                        <input type="checkbox" id="check-${index}-5" onchange="updateSource(${index})">
                        <label for="check-${index}-5">‚úì Extraction successful</label>
                    </div>
                </div>

                ${source.patterns.container ? `
                <div class="pattern-library">
                    <strong>Known Patterns:</strong>
                    ${source.patterns.container ? `<div class="pattern-code">Container: ${source.patterns.container}</div>` : ''}
                    ${source.patterns.date ? `<div class="pattern-code">Date: ${source.patterns.date}</div>` : ''}
                    ${source.patterns.special ? `<div class="pattern-code">‚ö†Ô∏è ${source.patterns.special}</div>` : ''}
                </div>
                ` : ''}

                <textarea class="audit-notes" placeholder="Audit notes... (HTML patterns, issues, fixes needed)" id="notes-${index}"></textarea>

                <div class="action-buttons">
                    <button class="action-btn btn-test" onclick="testSource(${index})">Test</button>
                    <button class="action-btn btn-fix" onclick="openSource(${index})">Open URL</button>
                    <button class="action-btn btn-save" onclick="saveAudit(${index})">Save</button>
                </div>
            `;
            return card;
        }

        function updateSource(index) {
            // Count checked items to determine status
            let checkedCount = 0;
            for (let i = 1; i <= 5; i++) {
                if (document.getElementById(`check-${index}-${i}`).checked) {
                    checkedCount++;
                }
            }

            // Update status based on checks
            if (checkedCount === 5) {
                sources[index].status = 'working';
            } else if (checkedCount >= 3) {
                sources[index].status = 'partial';
            } else if (checkedCount > 0) {
                sources[index].status = 'failing';
            }

            initDashboard();
        }

        function updateSummary() {
            const working = sources.filter(s => s.status === 'working').length;
            const partial = sources.filter(s => s.status === 'partial').length;
            const failing = sources.filter(s => s.status === 'failing').length;

            document.getElementById('workingSources').textContent = working;
            document.getElementById('partialSources').textContent = partial;
            document.getElementById('failingSources').textContent = failing;

            const progress = (working / sources.length) * 100;
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = `${progress}%`;
            progressBar.textContent = `${Math.round(progress)}% Complete`;
        }

        function testSource(index) {
            const source = sources[index];
            const adminToken = localStorage.getItem('radarAdminToken') || prompt('Enter RADAR Admin Token:');
            if (!adminToken) return;

            // Make API call to test extraction
            fetch('/api/radar/extract-firecrawl', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${adminToken}`
                },
                body: JSON.stringify({
                    sourceName: source.name,
                    testMode: true
                })
            })
            .then(res => res.json())
            .then(data => {
                sources[index].events_found = data.events_found || 0;
                sources[index].last_check = new Date().toISOString();

                if (data.events_found > 0) {
                    sources[index].status = 'working';
                } else {
                    sources[index].status = 'failing';
                }

                initDashboard();
                alert(`${source.name}: Found ${data.events_found} events`);
            })
            .catch(err => {
                alert(`Test failed: ${err.message}`);
            });
        }

        function openSource(index) {
            window.open(sources[index].url, '_blank');
        }

        function saveAudit(index) {
            const notes = document.getElementById(`notes-${index}`).value;
            sources[index].audit_notes = notes;

            // Save to localStorage
            localStorage.setItem('radarAuditData', JSON.stringify(sources));
            alert('Audit data saved!');
        }

        function auditAllSources() {
            alert('Opening all sources in new tabs for manual audit...');
            sources.forEach(s => {
                setTimeout(() => window.open(s.url, '_blank'), 500);
            });
        }

        function generateReport() {
            const report = {
                timestamp: new Date().toISOString(),
                summary: {
                    total: sources.length,
                    working: sources.filter(s => s.status === 'working').length,
                    partial: sources.filter(s => s.status === 'partial').length,
                    failing: sources.filter(s => s.status === 'failing').length,
                    untested: sources.filter(s => s.status === 'untested').length
                },
                sources: sources.map(s => ({
                    name: s.name,
                    url: s.url,
                    status: s.status,
                    events_found: s.events_found,
                    patterns: s.patterns,
                    notes: s.audit_notes
                }))
            };

            console.log('Audit Report:', report);

            // Download as JSON
            const blob = new Blob([JSON.stringify(report, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `radar-audit-${Date.now()}.json`;
            a.click();
        }

        function exportPatterns() {
            const patterns = sources.map(s => ({
                name: s.name,
                patterns: s.patterns,
                notes: s.audit_notes
            }));

            const blob = new Blob([JSON.stringify(patterns, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `radar-patterns-${Date.now()}.json`;
            a.click();
        }

        function testExtraction() {
            // Test all sources sequentially
            let index = 0;

            function testNext() {
                if (index < sources.length) {
                    testSource(index);
                    index++;
                    setTimeout(testNext, 3000); // Wait 3 seconds between tests
                }
            }

            testNext();
        }

        // Load saved data if available
        const savedData = localStorage.getItem('radarAuditData');
        if (savedData) {
            const parsed = JSON.parse(savedData);
            sources.forEach((s, i) => {
                if (parsed[i]) {
                    sources[i] = { ...sources[i], ...parsed[i] };
                }
            });
        }

        // Initialize on load
        initDashboard();
    </script>
</body>
</html>